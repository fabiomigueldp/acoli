{% extends 'base.html' %}
{% load extras %}
{% block title %}Escala geral{% endblock %}
{% block content %}
<div class="space-y-6">
  <div class="card space-y-4">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div>
        <h2 class="font-serif text-xl">Visao geral das escalas</h2>
        <p class="text-sm text-slate">Uma visao compacta para encontrar buracos e agir rapido.</p>
      </div>
      <div class="flex flex-wrap gap-2">
        <a class="btn-secondary" href="{% url 'roster_export_pdf' %}?start={{ start_date|date:'Y-m-d' }}&end={{ end_date|date:'Y-m-d' }}{% if community_id %}&community={{ community_id }}{% endif %}{% if kind %}&kind={{ kind }}{% endif %}">Exportar PDF</a>
        <button class="btn-secondary" type="button" data-whatsapp-url="{% url 'roster_export_whatsapp' %}?start={{ start_date|date:'Y-m-d' }}&end={{ end_date|date:'Y-m-d' }}{% if community_id %}&community={{ community_id }}{% endif %}{% if kind %}&kind={{ kind }}{% endif %}">Copiar WhatsApp</button>
      </div>
    </div>
    <form method="get" class="grid sm:grid-cols-5 gap-3">
      <div>
        <label class="label">Data inicio</label>
        <input type="date" name="start" value="{{ start_date|date:'Y-m-d' }}" />
      </div>
      <div>
        <label class="label">Data final</label>
        <input type="date" name="end" value="{{ end_date|date:'Y-m-d' }}" />
      </div>
       <div>
         <label class="label">Comunidade</label>
         <div class="custom-select">
           <input type="hidden" name="community" value="{{ community_id }}">
           <button type="button" class="custom-select-button">
             <span class="selected-text">
               {% if community_id %}
                 {% for community in communities %}
                   {% if community_id|stringformat:"s" == community.id|stringformat:"s" %}{{ community.code }}{% endif %}
                 {% endfor %}
               {% else %}
                 Todas
               {% endif %}
             </span>
           </button>
           <div class="custom-select-options">
             <button type="button" class="custom-select-option {% if not community_id %}selected{% endif %}" data-value="">Todas</button>
             {% for community in communities %}
               <button type="button" class="custom-select-option {% if community_id|stringformat:"s" == community.id|stringformat:"s" %}selected{% endif %}" data-value="{{ community.id }}">{{ community.code }}</button>
             {% endfor %}
           </div>
         </div>
       </div>
       <div>
         <label class="label">Tipo</label>
         <div class="custom-select">
           <input type="hidden" name="kind" value="{{ kind }}">
           <button type="button" class="custom-select-button">
             <span class="selected-text">
               {% if kind == "template" %}Templates{% elif kind == "event" %}Eventos{% else %}Todos{% endif %}
             </span>
           </button>
           <div class="custom-select-options">
             <button type="button" class="custom-select-option {% if not kind %}selected{% endif %}" data-value="">Todos</button>
             <button type="button" class="custom-select-option {% if kind == "template" %}selected{% endif %}" data-value="template">Templates</button>
             <button type="button" class="custom-select-option {% if kind == "event" %}selected{% endif %}" data-value="event">Eventos</button>
           </div>
         </div>
       </div>
      <div class="flex items-end">
        <button class="btn-primary" type="submit">Filtrar</button>
      </div>
    </form>
    <div class="flex flex-wrap gap-2 text-xs">
      {% for preset in presets %}
        <a class="btn-secondary" href="?start={{ preset.start|date:'Y-m-d' }}&end={{ preset.end|date:'Y-m-d' }}{% if community_id %}&community={{ community_id }}{% endif %}{% if kind %}&kind={{ kind }}{% endif %}">{{ preset.label }}</a>
      {% endfor %}
    </div>
  </div>

  {% if not days %}
    <div class="card">
      <p class="text-sm text-slate">Nenhuma missa encontrada no periodo selecionado.</p>
    </div>
  {% endif %}

  {% for day in days %}
    <div class="card">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="font-semibold">{{ day.date|date:"d/m/Y" }}</h3>
          <p class="text-xs text-slate">{{ day.date|date:"l" }}</p>
        </div>
      </div>
      <div class="mt-4 space-y-3 lg:hidden">
        {% for item in day.items %}
          {% with instance=item.instance %}
            <div class="rounded-xl border border-black/5 bg-white/80 p-4">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="text-sm text-slate">{{ instance.starts_at|date:"H:i" }} Â· {{ instance.community.code }}</div>
                  <div class="text-base font-medium text-ink">{{ instance.liturgy_label|default:"Missa" }}</div>
                </div>
                <a class="btn-secondary btn-compact" href="{% url 'mass_detail' instance.id %}">Ver</a>
              </div>
              <div class="mt-3 space-y-2">
                {% for column in columns %}
                  {% with slot=item.slot_map|get_item:column.key %}
                    <div class="flex items-center justify-between gap-3 text-sm border-t border-sand-100 pt-2">
                      <span class="text-slate">{{ column.label }}</span>
                      <span class="text-ink">
                        {% if instance.status == "canceled" %}
                          <span class="text-xs uppercase tracking-widest text-slate">Cancelada</span>
                        {% elif not slot or not slot.required %}
                          <span class="text-slate">N/A</span>
                        {% elif slot.externally_covered %}
                          <span class="text-xs uppercase tracking-widest text-slate">Externo</span>
                        {% else %}
                          {% with active=slot.active_assignment %}
                            {% if active %}
                              <span>{{ active.acolyte.display_name }}</span>
                              {% if slot.is_locked %}
                                <span class="ml-2 badge">Consolidada</span>
                              {% endif %}
                            {% else %}
                              <a class="btn-secondary btn-compact" href="{% url 'slot_assign' instance.id slot.id %}">Atribuir</a>
                              {% if slot.is_locked %}
                                <span class="ml-2 badge">Consolidada</span>
                              {% endif %}
                            {% endif %}
                          {% endwith %}
                        {% endif %}
                      </span>
                    </div>
                  {% endwith %}
                {% endfor %}
              </div>
            </div>
          {% endwith %}
        {% endfor %}
      </div>

      <div class="overflow-x-auto mt-4 hidden lg:block">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-xs text-slate uppercase tracking-widest">
              <th class="py-2 pr-3">Hora</th>
              <th class="py-2 pr-3">Comunidade</th>
              <th class="py-2 pr-3">Rotulo</th>
              {% for column in columns %}
                <th class="py-2 pr-3" title="{{ column.title }}">{{ column.label }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for item in day.items %}
              {% with instance=item.instance %}
                <tr class="border-t border-black/5 {% if instance.status == 'canceled' %}text-slate{% endif %}">
                  <td class="py-2 pr-3">{{ instance.starts_at|date:"H:i" }}</td>
                  <td class="py-2 pr-3">{{ instance.community.code }}</td>
                  <td class="py-2 pr-3">{{ instance.liturgy_label|default:"Missa" }}</td>
                  {% for column in columns %}
                    {% with slot=item.slot_map|get_item:column.key %}
                      <td class="py-2 pr-3">
                        {% if instance.status == "canceled" %}
                          <span class="text-xs uppercase tracking-widest">Cancelada</span>
                        {% elif not slot %}
                          <span class="text-slate">N/A</span>
                        {% elif slot.externally_covered %}
                          <span class="text-xs uppercase tracking-widest">Externo</span>
                        {% elif not slot.required %}
                          <span class="text-slate">N/A</span>
                        {% else %}
                          {% with active=slot.active_assignment %}
                            {% if active %}
                              <a class="text-ink hover:underline" href="{% url 'mass_detail' instance.id %}">{{ active.acolyte.display_name }}</a>
                              {% if slot.is_locked %}
                                <span class="ml-2 badge">Consolidada</span>
                              {% endif %}
                            {% else %}
                              <a class="inline-flex items-center gap-2 px-2 py-1 rounded-lg bg-red-50 text-red-700 border border-red-200" href="{% url 'slot_assign' instance.id slot.id %}">
                                ABERTO
                              </a>
                              {% if slot.is_locked %}
                                <span class="ml-2 badge">Consolidada</span>
                              {% endif %}
                            {% endif %}
                          {% endwith %}
                        {% endif %}
                      </td>
                    {% endwith %}
                  {% endfor %}
                </tr>
              {% endwith %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endfor %}
</div>

<script>
  document.querySelectorAll("[data-whatsapp-url]").forEach(function(btn) {
    btn.addEventListener("click", async function() {
      const url = btn.getAttribute("data-whatsapp-url");
      try {
        const response = await fetch(url, { credentials: "same-origin" });
        const text = await response.text();
        await navigator.clipboard.writeText(text);
        btn.textContent = "Copiado";
        setTimeout(() => { btn.textContent = "Copiar WhatsApp"; }, 1600);
      } catch (err) {
        alert("Nao foi possivel copiar. Abra o link e copie manualmente.");
      }
    });
  });
</script>
{% endblock %}
