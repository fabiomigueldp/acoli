{% load static %}
{% load extras %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f5e4d" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Acoli" />
  <meta name="mobile-web-app-capable" content="yes" />
  <link rel="manifest" href="{% url 'pwa_manifest' %}" />
  <link rel="icon" href="{% static 'pwa/favicon.ico' %}" sizes="any" />
  <link rel="apple-touch-icon" href="{% static 'pwa/apple-touch-icon.png' %}" />
  <link rel="mask-icon" href="{% static 'pwa/safari-pinned-tab.svg' %}" color="#0f5e4d" />
  <link rel="apple-touch-startup-image" href="{% static 'pwa/splash-iphone.png' %}" />
  <title>{% block title %}Acoli{% endblock %}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ["Alegreya Sans", "sans-serif"],
            serif: ["Fraunces", "serif"],
          },
          colors: {
            ink: "#0b1f26",
            slate: "#5a6a72",
            sand: "#f3efe6",
            moss: "#0f5e4d",
            sun: "#d9a441",
          },
          boxShadow: {
            soft: "0 12px 30px rgba(10, 24, 32, 0.12)",
          },
        },
      },
    };
  </script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Alegreya+Sans:wght@400;500;600;700&family=Fraunces:wght@600;700&display=swap" />
  <link rel="stylesheet" href="{% static 'css/app.css' %}" />
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script src="https://unpkg.com/lucide@latest" defer></script>
</head>
 <body class="bg-white text-ink min-h-screen" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
   <a href="#main-content" class="skip-link">Pular para o conteudo</a>
  <div class="absolute inset-0 pointer-events-none"></div>
  <div class="relative">
    <header class="sticky top-0 z-40 bg-white/90 backdrop-blur-md border-b border-black/8 shadow-soft">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16 sm:h-20">
          <div class="flex items-center gap-6">
            <a href="{% url 'dashboard' %}" class="font-serif text-2xl text-moss hover:text-sun transition-colors duration-200">Acoli</a>
            {% if active_parish %}
              <div class="hidden sm:flex items-center text-sm text-slate border-l border-black/10 pl-6">
                <span class="font-medium text-ink">{{ active_parish.name }}</span>
                <span class="mx-3 text-black/20">•</span>
                <span>{{ active_parish.city }}</span>
              </div>
            {% endif %}
          </div>
          <div class="flex items-center gap-3">
            {% if request.user.is_authenticated %}
              <button id="mobile-menu-btn" type="button" aria-expanded="false" aria-controls="mobile-menu-panel" aria-label="Abrir menu" class="sm:hidden inline-flex items-center justify-center h-11 w-11 rounded-xl border border-black/10 bg-white/80 text-ink shadow-sm transition-colors duration-150 hover:bg-white">
                <i data-lucide="menu" class="w-5 h-5" aria-hidden="true"></i>
              </button>
              <div class="hidden sm:flex items-center gap-4">
                <div class="flex items-center gap-2">
                  <span class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-sand-200 bg-sand-100 text-xs font-semibold text-ink">
                    {{ request.user.full_name|default:request.user.email|initials }}
                  </span>
                  <span class="hidden sm:block max-w-[160px] truncate text-sm font-medium text-ink">
                    {{ request.user.full_name|default:request.user.email }}
                  </span>
                </div>
                {% if request.resolver_match and request.resolver_match.url_name == "dashboard" and is_admin and acolyte %}
                  <div class="inline-flex rounded-full border border-sand-200 bg-sand-50 p-1 text-xs font-medium sm:text-sm">
                    <a
                      href="?view=admin"
                      class="rounded-full px-2 py-1 transition-colors sm:px-3 {% if dashboard_view == 'admin' %}bg-white text-ink shadow-sm{% else %}text-slate hover:text-ink{% endif %}">
                      Admin
                    </a>
                    <a
                      href="?view=acolyte"
                      class="rounded-full px-2 py-1 transition-colors sm:px-3 {% if dashboard_view == 'acolyte' %}bg-white text-ink shadow-sm{% else %}text-slate hover:text-ink{% endif %}">
                      Acolito
                    </a>
                  </div>
                {% endif %}
                {% if parish_memberships %}
                  <div class="relative group">
                    <button class="text-sm px-4 py-2 rounded-xl border border-black/12 bg-white/80 hover:bg-white hover:border-black/20 transition-all duration-200 shadow-sm hover:shadow-md">Trocar paroquia</button>
                    <div class="absolute right-0 mt-3 w-64 bg-white shadow-soft rounded-xl p-3 hidden group-hover:block group-focus-within:block border border-black/5">
                      {% for membership in parish_memberships %}
                        <a class="block text-sm px-4 py-3 rounded-lg hover:bg-sand transition-colors duration-150" href="{% url 'switch_parish' membership.parish_id %}">{{ membership.parish.name }}</a>
                      {% endfor %}
                    </div>
                  </div>
                {% endif %}
                <a class="text-sm text-slate hover:text-ink transition-colors duration-200 px-3 py-2 rounded-lg hover:bg-sand/50" href="{% url 'logout_confirm' %}">Sair</a>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </header>

     <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-6 pb-6 grid lg:grid-cols-[220px_1fr] gap-6">
      <nav class="hidden lg:flex flex-col gap-3 text-sm bg-white/50 backdrop-blur-sm rounded-2xl p-6 shadow-soft border border-white/20">
        <a class="nav-link" href="{% url 'dashboard' %}">Painel</a>
        <a class="nav-link" href="{% url 'calendar_month' %}">Calendario</a>
        <a class="nav-link" href="{% url 'my_assignments' %}">Minhas escalas</a>
        <a class="nav-link" href="{% url 'my_preferences' %}">Preferencias</a>
        <a class="nav-link" href="{% url 'swap_requests' %}">Trocas</a>
        <a class="nav-link" href="{% url 'event_interest' %}">Eventos</a>
        {% if can_manage_parish %}
          <div class="pt-6 text-xs uppercase tracking-widest text-slate font-medium border-t border-black/10 mt-4">Administração</div>
          <a class="nav-link" href="{% url 'people_directory' %}">Pessoas</a>
          <a class="nav-link" href="{% url 'template_list' %}">Horarios fixos</a>
          <a class="nav-link" href="{% url 'event_series_list' %}">Programacao liturgica</a>
          <a class="nav-link" href="{% url 'roster_view' %}">Escala geral</a>
          <a class="nav-link" href="{% url 'roster_open_slots' %}">Slots abertos</a>
          <a class="nav-link" href="{% url 'scheduling_dashboard' %}">Escalonar</a>
          <a class="nav-link" href="{% url 'replacement_center' %}">Substituicoes</a>
          <a class="nav-link" href="{% url 'reports_frequency' %}">Relatorios</a>
          <a class="nav-link" href="{% url 'audit_log' %}">Auditoria</a>
          <div class="pt-4 text-xs uppercase tracking-widest text-slate font-medium border-t border-black/10 mt-4">Estrutura</div>
          <a class="nav-link" href="{% url 'structure_communities_list' %}">Comunidades</a>
          <a class="nav-link" href="{% url 'structure_roles_list' %}">Funcoes na escala</a>
          <a class="nav-link" href="{% url 'structure_requirement_profiles_list' %}">Perfis de requisitos</a>
          <a class="nav-link" href="{% url 'parish_settings' %}">Configuracoes</a>
        {% endif %}
      </nav>

       <main id="main-content">
        <!-- Toast Notifications Container -->
        <div id="toast-container" class="fixed top-24 left-4 right-4 sm:left-auto sm:right-6 z-50 space-y-2 pointer-events-none">
          <!-- Toasts will be injected here -->
        </div>
        {% include 'partials/_messages.html' %}

        {% block content %}{% endblock %}
      </main>
    </div>

    <!-- Mobile Navigation Menu -->
    {% if request.user.is_authenticated %}
      <div id="mobile-menu-backdrop" class="fixed inset-0 bg-black/20 backdrop-blur-sm z-40 hidden sm:hidden opacity-0 transition-opacity duration-200" aria-hidden="true"></div>
      <div id="mobile-menu-panel" role="dialog" aria-modal="true" aria-label="Menu de navegacao" aria-hidden="true" class="fixed inset-0 z-50 sm:hidden translate-x-full transition-transform duration-200 ease-out pointer-events-none">
           <div class="h-full bg-white/95 backdrop-blur-md shadow-soft border-l border-black/10 overflow-y-auto" role="document">
          <div class="px-6 pt-6 pb-4 flex items-center justify-between gap-4">
            <div class="flex items-center gap-3 min-w-0">
              <span class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-sand-200 bg-sand-100 text-sm font-semibold text-ink">
                {{ request.user.full_name|default:request.user.email|initials }}
              </span>
              <div class="min-w-0">
                <div class="text-sm font-semibold text-ink truncate">{{ request.user.full_name|default:request.user.email }}</div>
                {% if active_parish %}
                  <div class="text-xs text-slate truncate">{{ active_parish.name }}</div>
                {% endif %}
              </div>
            </div>
            <button id="mobile-menu-close" type="button" aria-label="Fechar menu" class="inline-flex items-center justify-center h-10 w-10 rounded-xl border border-black/10 bg-white/80 text-ink shadow-sm transition-colors duration-150 hover:bg-white">
              <i data-lucide="x" class="w-5 h-5" aria-hidden="true"></i>
            </button>
          </div>

          <div class="px-6 pb-8 space-y-6">
            {% if request.resolver_match and request.resolver_match.url_name == "dashboard" and is_admin and acolyte %}
              <div class="rounded-xl border border-black/10 bg-white/80 px-4 py-3 flex items-center justify-between gap-3">
                <div>
                  <div class="text-xs uppercase tracking-widest text-slate">Modo do painel</div>
                  <div class="text-sm font-medium text-ink">{% if dashboard_view == "admin" %}Admin{% else %}Acolito{% endif %}</div>
                </div>
                {% if dashboard_view == "admin" %}
                  <a href="?view=acolyte" class="btn-secondary btn-compact">Acolito</a>
                {% else %}
                  <a href="?view=admin" class="btn-secondary btn-compact">Admin</a>
                {% endif %}
              </div>
            {% endif %}

            <div>
              <div class="text-xs uppercase tracking-widest text-slate font-medium mb-2">Acolito</div>
              <div class="space-y-1">
                <a href="{% url 'dashboard' %}" class="flex items-center gap-4 px-4 py-3 rounded-xl transition-colors duration-150 {% if request.resolver_match.url_name == 'dashboard' %}bg-moss-50 text-moss{% else %}text-ink hover:bg-sand/60{% endif %}" {% if request.resolver_match.url_name == 'dashboard' %}aria-current="page"{% endif %}>
                  <i data-lucide="home" class="w-5 h-5" aria-hidden="true"></i>
                  <span class="font-medium">Painel</span>
                </a>
                <a href="{% url 'calendar_month' %}" class="flex items-center gap-4 px-4 py-3 rounded-xl transition-colors duration-150 {% if request.resolver_match.url_name == 'calendar_month' %}bg-moss-50 text-moss{% else %}text-ink hover:bg-sand/60{% endif %}" {% if request.resolver_match.url_name == 'calendar_month' %}aria-current="page"{% endif %}>
                  <i data-lucide="calendar" class="w-5 h-5" aria-hidden="true"></i>
                  <span class="font-medium">Calendario</span>
                </a>
                <a href="{% url 'my_assignments' %}" class="flex items-center gap-4 px-4 py-3 rounded-xl transition-colors duration-150 {% if request.resolver_match.url_name == 'my_assignments' %}bg-moss-50 text-moss{% else %}text-ink hover:bg-sand/60{% endif %}" {% if request.resolver_match.url_name == 'my_assignments' %}aria-current="page"{% endif %}>
                  <i data-lucide="calendar-check" class="w-5 h-5" aria-hidden="true"></i>
                  <span class="font-medium">Minhas escalas</span>
                </a>
                <a href="{% url 'my_preferences' %}" class="flex items-center gap-4 px-4 py-3 rounded-xl transition-colors duration-150 {% if request.resolver_match.url_name == 'my_preferences' %}bg-moss-50 text-moss{% else %}text-ink hover:bg-sand/60{% endif %}" {% if request.resolver_match.url_name == 'my_preferences' %}aria-current="page"{% endif %}>
                  <i data-lucide="settings" class="w-5 h-5" aria-hidden="true"></i>
                  <span class="font-medium">Preferencias</span>
                </a>
                <a href="{% url 'swap_requests' %}" class="flex items-center gap-4 px-4 py-3 rounded-xl transition-colors duration-150 {% if request.resolver_match.url_name == 'swap_requests' %}bg-moss-50 text-moss{% else %}text-ink hover:bg-sand/60{% endif %}" {% if request.resolver_match.url_name == 'swap_requests' %}aria-current="page"{% endif %}>
                  <i data-lucide="arrow-left-right" class="w-5 h-5" aria-hidden="true"></i>
                  <span class="font-medium">Trocas</span>
                </a>
                <a href="{% url 'event_interest' %}" class="flex items-center gap-4 px-4 py-3 rounded-xl transition-colors duration-150 {% if request.resolver_match.url_name == 'event_interest' %}bg-moss-50 text-moss{% else %}text-ink hover:bg-sand/60{% endif %}" {% if request.resolver_match.url_name == 'event_interest' %}aria-current="page"{% endif %}>
                  <i data-lucide="star" class="w-5 h-5" aria-hidden="true"></i>
                  <span class="font-medium">Eventos</span>
                </a>
              </div>
            </div>

            {% if can_manage_parish %}
              <div>
                <div class="text-xs uppercase tracking-widest text-slate font-medium mb-2">Administracao</div>
                <div class="space-y-1">
                  <a href="{% url 'people_directory' %}" class="flex items-center gap-4 px-4 py-3 rounded-xl transition-colors duration-150 {% if request.resolver_match.url_name == 'people_directory' %}bg-moss-50 text-moss{% else %}text-ink hover:bg-sand/60{% endif %}" {% if request.resolver_match.url_name == 'people_directory' %}aria-current="page"{% endif %}>
                    <i data-lucide="users" class="w-5 h-5" aria-hidden="true"></i>
                    <span class="font-medium">Pessoas</span>
                  </a>
                  <a href="{% url 'template_list' %}" class="flex items-center gap-4 px-4 py-3 rounded-xl transition-colors duration-150 {% if request.resolver_match.url_name == 'template_list' %}bg-moss-50 text-moss{% else %}text-ink hover:bg-sand/60{% endif %}" {% if request.resolver_match.url_name == 'template_list' %}aria-current="page"{% endif %}>
                    <i data-lucide="list" class="w-5 h-5" aria-hidden="true"></i>
                    <span class="font-medium">Horarios fixos</span>
                  </a>
                  <a href="{% url 'event_series_list' %}" class="flex items-center gap-4 px-4 py-3 rounded-xl transition-colors duration-150 {% if request.resolver_match.url_name == 'event_series_list' %}bg-moss-50 text-moss{% else %}text-ink hover:bg-sand/60{% endif %}" {% if request.resolver_match.url_name == 'event_series_list' %}aria-current="page"{% endif %}>
                    <i data-lucide="calendar-plus" class="w-5 h-5" aria-hidden="true"></i>
                    <span class="font-medium">Programacao liturgica</span>
                  </a>
                  <a href="{% url 'roster_view' %}" class="flex items-center gap-4 px-4 py-3 rounded-xl transition-colors duration-150 {% if request.resolver_match.url_name == 'roster_view' %}bg-moss-50 text-moss{% else %}text-ink hover:bg-sand/60{% endif %}" {% if request.resolver_match.url_name == 'roster_view' %}aria-current="page"{% endif %}>
                    <i data-lucide="clipboard-list" class="w-5 h-5" aria-hidden="true"></i>
                    <span class="font-medium">Escala geral</span>
                  </a>
                  <a href="{% url 'roster_open_slots' %}" class="flex items-center gap-4 px-4 py-3 rounded-xl transition-colors duration-150 {% if request.resolver_match.url_name == 'roster_open_slots' %}bg-moss-50 text-moss{% else %}text-ink hover:bg-sand/60{% endif %}" {% if request.resolver_match.url_name == 'roster_open_slots' %}aria-current="page"{% endif %}>
                    <i data-lucide="plus-square" class="w-5 h-5" aria-hidden="true"></i>
                    <span class="font-medium">Slots abertos</span>
                  </a>
                  <a href="{% url 'scheduling_dashboard' %}" class="flex items-center gap-4 px-4 py-3 rounded-xl transition-colors duration-150 {% if request.resolver_match.url_name == 'scheduling_dashboard' %}bg-moss-50 text-moss{% else %}text-ink hover:bg-sand/60{% endif %}" {% if request.resolver_match.url_name == 'scheduling_dashboard' %}aria-current="page"{% endif %}>
                    <i data-lucide="calendar-clock" class="w-5 h-5" aria-hidden="true"></i>
                    <span class="font-medium">Escalonar</span>
                  </a>
                  <a href="{% url 'replacement_center' %}" class="flex items-center gap-4 px-4 py-3 rounded-xl transition-colors duration-150 {% if request.resolver_match.url_name == 'replacement_center' %}bg-moss-50 text-moss{% else %}text-ink hover:bg-sand/60{% endif %}" {% if request.resolver_match.url_name == 'replacement_center' %}aria-current="page"{% endif %}>
                    <i data-lucide="user-plus" class="w-5 h-5" aria-hidden="true"></i>
                    <span class="font-medium">Substituicoes</span>
                  </a>
                  <a href="{% url 'reports_frequency' %}" class="flex items-center gap-4 px-4 py-3 rounded-xl transition-colors duration-150 {% if request.resolver_match.url_name == 'reports_frequency' %}bg-moss-50 text-moss{% else %}text-ink hover:bg-sand/60{% endif %}" {% if request.resolver_match.url_name == 'reports_frequency' %}aria-current="page"{% endif %}>
                    <i data-lucide="bar-chart-3" class="w-5 h-5" aria-hidden="true"></i>
                    <span class="font-medium">Relatorios</span>
                  </a>
                  <a href="{% url 'audit_log' %}" class="flex items-center gap-4 px-4 py-3 rounded-xl transition-colors duration-150 {% if request.resolver_match.url_name == 'audit_log' %}bg-moss-50 text-moss{% else %}text-ink hover:bg-sand/60{% endif %}" {% if request.resolver_match.url_name == 'audit_log' %}aria-current="page"{% endif %}>
                    <i data-lucide="shield-check" class="w-5 h-5" aria-hidden="true"></i>
                    <span class="font-medium">Auditoria</span>
                  </a>
                </div>
              </div>

              <div>
                <div class="text-xs uppercase tracking-widest text-slate font-medium mb-2">Estrutura</div>
                <div class="space-y-1">
                  <a href="{% url 'structure_communities_list' %}" class="flex items-center gap-4 px-4 py-3 rounded-xl transition-colors duration-150 {% if request.resolver_match.url_name == 'structure_communities_list' %}bg-moss-50 text-moss{% else %}text-ink hover:bg-sand/60{% endif %}" {% if request.resolver_match.url_name == 'structure_communities_list' %}aria-current="page"{% endif %}>
                    <i data-lucide="building-2" class="w-5 h-5" aria-hidden="true"></i>
                    <span class="font-medium">Comunidades</span>
                  </a>
                  <a href="{% url 'structure_roles_list' %}" class="flex items-center gap-4 px-4 py-3 rounded-xl transition-colors duration-150 {% if request.resolver_match.url_name == 'structure_roles_list' %}bg-moss-50 text-moss{% else %}text-ink hover:bg-sand/60{% endif %}" {% if request.resolver_match.url_name == 'structure_roles_list' %}aria-current="page"{% endif %}>
                    <i data-lucide="layers" class="w-5 h-5" aria-hidden="true"></i>
                    <span class="font-medium">Funcoes na escala</span>
                  </a>
                  <a href="{% url 'structure_requirement_profiles_list' %}" class="flex items-center gap-4 px-4 py-3 rounded-xl transition-colors duration-150 {% if request.resolver_match.url_name == 'structure_requirement_profiles_list' %}bg-moss-50 text-moss{% else %}text-ink hover:bg-sand/60{% endif %}" {% if request.resolver_match.url_name == 'structure_requirement_profiles_list' %}aria-current="page"{% endif %}>
                    <i data-lucide="file-text" class="w-5 h-5" aria-hidden="true"></i>
                    <span class="font-medium">Perfis de requisitos</span>
                  </a>
                  <a href="{% url 'parish_settings' %}" class="flex items-center gap-4 px-4 py-3 rounded-xl transition-colors duration-150 {% if request.resolver_match.url_name == 'parish_settings' %}bg-moss-50 text-moss{% else %}text-ink hover:bg-sand/60{% endif %}" {% if request.resolver_match.url_name == 'parish_settings' %}aria-current="page"{% endif %}>
                    <i data-lucide="settings" class="w-5 h-5" aria-hidden="true"></i>
                    <span class="font-medium">Configuracoes</span>
                  </a>
                </div>
              </div>
            {% endif %}

            {% if parish_memberships and parish_memberships|length > 1 %}
              <div>
                <div class="text-xs uppercase tracking-widest text-slate font-medium mb-2">Paroquia</div>
                <div class="space-y-1">
                  {% for membership in parish_memberships %}
                    <a href="{% url 'switch_parish' membership.parish_id %}" class="flex items-center gap-4 px-4 py-3 rounded-xl transition-colors duration-150 text-ink hover:bg-sand/60 min-w-0">
                      <i data-lucide="building-2" class="w-5 h-5" aria-hidden="true"></i>
                      <span class="font-medium min-w-0 break-words">{{ membership.parish.name }}</span>
                    </a>
                  {% endfor %}
                </div>
              </div>
            {% endif %}

            <div>
              <div class="text-xs uppercase tracking-widest text-slate font-medium mb-2">Conta</div>
              <div class="space-y-1">
                <a href="{% url 'logout_confirm' %}" class="flex items-center gap-4 px-4 py-3 rounded-xl transition-colors duration-150 text-ink hover:bg-sand/60">
                  <i data-lucide="log-out" class="w-5 h-5" aria-hidden="true"></i>
                  <span class="font-medium">Sair</span>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <script>
      (function() {
        const btn = document.getElementById('mobile-menu-btn');
        const panel = document.getElementById('mobile-menu-panel');
        const backdrop = document.getElementById('mobile-menu-backdrop');
        const closeBtn = document.getElementById('mobile-menu-close');
        if (!btn || !panel || !backdrop) return;

         let lastFocused = null;

         function trapFocus(event) {
           if (btn.getAttribute('aria-expanded') !== 'true') {
             return;
           }
           if (event.key !== 'Tab') {
             return;
           }
           const focusable = panel.querySelectorAll('a[href], button:not([disabled]), [tabindex="0"]');
           if (!focusable.length) {
             return;
           }
           const first = focusable[0];
           const last = focusable[focusable.length - 1];
           if (event.shiftKey && document.activeElement === first) {
             event.preventDefault();
             last.focus();
           } else if (!event.shiftKey && document.activeElement === last) {
             event.preventDefault();
             first.focus();
           }
         }

         function openMenu() {
           lastFocused = document.activeElement;
           backdrop.classList.remove('hidden');
           requestAnimationFrame(() => {
             backdrop.classList.remove('opacity-0');
             backdrop.classList.add('opacity-100');
             panel.classList.remove('translate-x-full', 'pointer-events-none');
             panel.classList.add('translate-x-0');
             panel.setAttribute('aria-hidden', 'false');
           });
           btn.setAttribute('aria-expanded', 'true');
           document.body.style.overflow = 'hidden';
           const focusTarget = panel.querySelector('#mobile-menu-close') || panel.querySelector('a[href]');
           if (focusTarget) {
             focusTarget.focus();
           }
         }

         function closeMenu() {
           backdrop.classList.remove('opacity-100');
           backdrop.classList.add('opacity-0');
           panel.classList.remove('translate-x-0');
           panel.classList.add('translate-x-full', 'pointer-events-none');
           panel.setAttribute('aria-hidden', 'true');
           btn.setAttribute('aria-expanded', 'false');
           document.body.style.overflow = '';
           setTimeout(() => backdrop.classList.add('hidden'), 200);
           if (lastFocused && typeof lastFocused.focus === 'function') {
             lastFocused.focus();
           }
         }

        btn.addEventListener('click', openMenu);
        if (closeBtn) closeBtn.addEventListener('click', closeMenu);
        backdrop.addEventListener('click', closeMenu);
        panel.querySelectorAll('a').forEach((link) => {
          link.addEventListener('click', closeMenu);
        });
         document.addEventListener('keydown', trapFocus);
         document.addEventListener('keydown', (e) => {
           if (e.key === 'Escape' && btn.getAttribute('aria-expanded') === 'true') closeMenu();
         });
      })();
      </script>
    {% endif %}
   </div>

   <!-- Global Confirmation Modal -->
   <div id="confirm-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
     <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
       <div class="fixed inset-0 bg-ink/40 backdrop-blur-sm transition-opacity" aria-hidden="true" onclick="window.closeConfirmModal()"></div>
       <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
       <div class="inline-block align-bottom bg-white rounded-t-2xl sm:rounded-2xl text-left overflow-hidden shadow-soft transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full w-full max-h-[85vh] overflow-y-auto border border-black/5">
         <div class="bg-white px-6 pt-6 pb-4">
           <div class="sm:flex sm:items-start">
             <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
               <h3 class="text-lg font-semibold text-ink-900 mb-2" id="modal-title">
                 <!-- Title will be injected -->
               </h3>
               <div class="mt-2">
                 <p class="text-sm text-slate" id="modal-body">
                   <!-- Message will be injected -->
                 </p>
               </div>
             </div>
           </div>
         </div>
         <div class="bg-sand-50 px-6 py-4 sm:flex sm:flex-row-reverse gap-3">
           <button type="button" id="modal-confirm-btn" class="btn-primary w-full sm:w-auto">
             Confirmar
           </button>
           <button type="button" onclick="window.closeConfirmModal()" class="btn-secondary w-full sm:w-auto mt-3 sm:mt-0">
             Cancelar
           </button>
         </div>
       </div>
     </div>
   </div>

   <script>
     // ===== Toast Notification System =====
      window.showToast = function(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
       
       const bgColors = {
         success: 'bg-moss-50 border-moss-200 text-moss-800',
         error: 'bg-red-50 border-red-200 text-red-800',
         warning: 'bg-sun-50 border-sun-200 text-sun-800',
         info: 'bg-slate-50 border-slate-200 text-slate-800'
       };
       
       toast.className = `pointer-events-auto transform transition-all duration-300 ease-out translate-x-full opacity-0 rounded-xl border ${bgColors[type] || bgColors.success} px-4 py-3 text-sm shadow-soft backdrop-blur-sm max-w-sm`;
       toast.textContent = message;
       
       container.appendChild(toast);
       
       // Trigger animation
       requestAnimationFrame(() => {
         requestAnimationFrame(() => {
           toast.classList.remove('translate-x-full', 'opacity-0');
         });
       });
       
       // Auto dismiss after 4 seconds
        setTimeout(() => {
          toast.classList.add('translate-x-full', 'opacity-0');
          setTimeout(() => toast.remove(), 300);
        }, 4000);
      };

      if (window.pendingToasts && window.pendingToasts.length) {
        window.pendingToasts.forEach(([message, type]) => window.showToast(message, type));
        window.pendingToasts = [];
      }

     // ===== Confirmation Modal System =====
     window.showConfirmModal = function(message, onConfirm, title = 'Confirmar ação') {
       const modal = document.getElementById('confirm-modal');
       const modalTitle = document.getElementById('modal-title');
       const modalBody = document.getElementById('modal-body');
       const confirmBtn = document.getElementById('modal-confirm-btn');
       
       modalTitle.textContent = title;
       modalBody.textContent = message;
       
       // Remove old listeners by cloning the button
       const newConfirmBtn = confirmBtn.cloneNode(true);
       confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
       
       newConfirmBtn.addEventListener('click', function() {
         window.closeConfirmModal();
         onConfirm();
       });
       
       modal.classList.remove('hidden');
       document.body.style.overflow = 'hidden';
     };

     window.closeConfirmModal = function() {
       const modal = document.getElementById('confirm-modal');
       modal.classList.add('hidden');
       document.body.style.overflow = '';
     };

     // Close modal on ESC key
     document.addEventListener('keydown', function(e) {
       if (e.key === 'Escape') {
         window.closeConfirmModal();
       }
     });

      // ===== HTMX Confirmation Integration =====
      document.addEventListener('htmx:confirm', function(e) {
        // Only show modal if the element explicitly has hx-confirm attribute
        if (!e.detail.elt.hasAttribute('hx-confirm')) {
          return;
        }
        
        e.preventDefault();
        const message = e.detail.question || 'Tem certeza que deseja realizar esta ação?';
        
        window.showConfirmModal(message, function() {
          e.detail.issueRequest(true);
        });
      });

     // ===== HTMX Success Flash Effect =====
      document.addEventListener('htmx:afterSwap', function(e) {
        // Check if response has success message header
        const successMsg = e.detail.xhr.getResponseHeader('HX-Success-Message');
        if (!successMsg) {
          return;
        }

        window.showToast(successMsg, 'success');

        // Flash effect on updated elements
        const target = e.detail.target;
        if (target) {
          target.classList.add('htmx-success-flash');
          setTimeout(() => target.classList.remove('htmx-success-flash'), 1000);
        }
      });

       // ===== Custom Select Functionality =====
       window.initCustomSelects = function(root = document) {
        root.querySelectorAll('.custom-select:not([data-custom-select-init])').forEach(function(select) {
          const button = select.querySelector('.custom-select-button');
          const options = select.querySelector('.custom-select-options');
          const hiddenInput = select.querySelector('input[type="hidden"]');
          const nativeSelect = select.querySelector('select');

          // Store HTMX config for manual trigger
          let htmxConfig = null;
          if (button && hiddenInput) {
            const dataAttrs = ["data-hx-get", "data-hx-target", "data-hx-include", "data-hx-vals", "data-hx-swap", "data-hx-push-url", "data-hx-select", "data-hx-indicator"];
            const hasHtmx = dataAttrs.some(attr => button.hasAttribute(attr));
            if (hasHtmx) {
              htmxConfig = {};
              dataAttrs.forEach(attr => {
                const dataAttr = attr;
                const hxAttr = attr.replace('data-hx-', 'hx-');
                if (button.hasAttribute(dataAttr)) {
                  htmxConfig[hxAttr] = button.getAttribute(dataAttr);
                  button.removeAttribute(dataAttr);
                }
              });
            }
          }

          const optionButtons = options ? options.querySelectorAll('.custom-select-option') : [];
          if (options && optionButtons.length > 10 && !options.querySelector('.custom-select-search')) {
            const search = document.createElement('input');
            search.type = 'text';
            search.placeholder = 'Buscar...';
            search.className = 'custom-select-search';
            search.addEventListener('input', function(e) {
              const term = e.target.value.toLowerCase();
              optionButtons.forEach(function(opt) {
                const text = opt.textContent.trim().toLowerCase();
                opt.style.display = text.includes(term) ? '' : 'none';
              });
            });
            options.insertBefore(search, options.firstChild);
          }

          if (button) {
            button.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopImmediatePropagation();
              select.classList.toggle('open');
            });
          }

          select.querySelectorAll('.custom-select-option').forEach(function(option) {
            option.addEventListener('click', function(e) {
              e.preventDefault();
              const value = this.getAttribute('data-value');
              const text = this.textContent.trim();

              // Update button text
              const selectedText = button ? button.querySelector('.selected-text') : null;
              if (selectedText) {
                selectedText.textContent = text;
              }

              const updateField = function(field) {
                if (!field) {
                  return;
                }
                field.value = value;
                field.dispatchEvent(new Event('change', { bubbles: true }));
              };

              // Update hidden input/native select
              updateField(hiddenInput);
              updateField(nativeSelect);

              // Manual HTMX trigger if config exists
              if (window.htmx && htmxConfig && htmxConfig['hx-get']) {
                const vals = htmxConfig['hx-vals'] ? JSON.parse(htmxConfig['hx-vals']) : {};
                const include = htmxConfig['hx-include'] ? htmxConfig['hx-include'].split(',').map(s => s.trim()) : [];
                const values = {};
                include.forEach(selector => {
                  const el = document.querySelector(selector);
                  if (el && el.name) {
                    values[el.name] = el.value;
                  }
                });
                Object.assign(values, vals);
                window.htmx.ajax('GET', htmxConfig['hx-get'], {
                  target: htmxConfig['hx-target'] || '#tab-content',
                  values: values,
                  swap: htmxConfig['hx-swap'] || 'innerHTML'
                });
              }

              // Update selected state
              select.querySelectorAll('.custom-select-option').forEach(function(opt) {
                opt.classList.remove('selected');
              });
              this.classList.add('selected');

              // Close dropdown
              select.classList.remove('open');
            });
          });

          // Mark as initialized
          select.setAttribute('data-custom-select-init', 'true');
        });
      }

      document.addEventListener('DOMContentLoaded', function() {
        initCustomSelects();
      });

      // Re-initialize after HTMX swaps
      document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'tab-content' || evt.detail.target.id === 'modal-container' || evt.detail.target.id === 'modal-content') {
          initCustomSelects(evt.detail.target);
        }
      });

      // Close dropdowns when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.custom-select')) {
          document.querySelectorAll('.custom-select.open').forEach(function(select) {
            select.classList.remove('open');
          });
        }
      });
    </script>
    <script>
      function initLucideIcons() {
        if (window.lucide) {
          window.lucide.createIcons({
            attrs: { 'stroke-width': '1.5' }
          });
        }
      }

      document.addEventListener('DOMContentLoaded', initLucideIcons);
      document.body.addEventListener('htmx:afterSwap', initLucideIcons);
    </script>
    <script>
    (function() {
      if (!('serviceWorker' in navigator)) {
        return;
      }
      let refreshing = false;
      function onControllerChange() {
        if (refreshing) {
          return;
        }
        refreshing = true;
        window.location.reload();
      }
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('{% url "pwa_sw" %}', { updateViaCache: 'none' })
          .then(function(reg) {
            navigator.serviceWorker.addEventListener('controllerchange', onControllerChange);
            reg.update().catch(function() {});
            document.addEventListener('visibilitychange', function() {
              if (document.visibilityState === 'visible') {
                reg.update().catch(function() {});
              }
            });
          })
          .catch(function() {});
      });
    })();
    </script>
 </body>
</html>
