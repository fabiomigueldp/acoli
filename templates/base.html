{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Acoli{% endblock %}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ["Space Grotesk", "sans-serif"],
            serif: ["Fraunces", "serif"],
          },
          colors: {
            ink: "#0b1f26",
            slate: "#5a6a72",
            sand: "#f3efe6",
            moss: "#0f5e4d",
            sun: "#d9a441",
          },
          boxShadow: {
            soft: "0 12px 30px rgba(10, 24, 32, 0.12)",
          },
        },
      },
    };
  </script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Fraunces:wght@600;700&display=swap" />
  <link rel="stylesheet" href="{% static 'css/app.css' %}" />
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body class="bg-sand text-ink min-h-screen" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
  <div class="absolute inset-0 bg-gradient-to-br from-sand via-white to-[#f2f7f1] pointer-events-none"></div>
  <div class="relative">
    <header class="sticky top-0 z-40 bg-white/90 backdrop-blur-md border-b border-black/8 shadow-soft">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-20">
          <div class="flex items-center gap-6">
            <a href="{% url 'dashboard' %}" class="font-serif text-2xl text-moss hover:text-sun transition-colors duration-200">Acoli</a>
            {% if active_parish %}
              <div class="hidden sm:flex items-center text-sm text-slate border-l border-black/10 pl-6">
                <span class="font-medium text-ink">{{ active_parish.name }}</span>
                <span class="mx-3 text-black/20">•</span>
                <span>{{ active_parish.city }}</span>
              </div>
            {% endif %}
          </div>
          <div class="flex items-center gap-4">
            {% if parish_memberships %}
              <div class="relative group">
                <button class="text-sm px-4 py-2 rounded-xl border border-black/12 bg-white/80 hover:bg-white hover:border-black/20 transition-all duration-200 shadow-sm hover:shadow-md">Trocar paroquia</button>
                <div class="absolute right-0 mt-3 w-64 bg-white shadow-soft rounded-xl p-3 hidden group-hover:block border border-black/5">
                  {% for membership in parish_memberships %}
                    <a class="block text-sm px-4 py-3 rounded-lg hover:bg-sand transition-colors duration-150" href="{% url 'switch_parish' membership.parish_id %}">{{ membership.parish.name }}</a>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
            {% if request.user.is_authenticated %}
              <a class="text-sm text-slate hover:text-ink transition-colors duration-200" href="{% url 'logout_confirm' %}">Sair</a>
            {% endif %}
          </div>
        </div>
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 grid lg:grid-cols-[220px_1fr] gap-6">
      <nav class="hidden lg:flex flex-col gap-3 text-sm bg-white/50 backdrop-blur-sm rounded-2xl p-6 shadow-soft border border-white/20">
        <a class="nav-link" href="{% url 'dashboard' %}">Painel</a>
        <a class="nav-link" href="{% url 'calendar_month' %}">Calendario</a>
        <a class="nav-link" href="{% url 'my_assignments' %}">Minhas escalas</a>
        <a class="nav-link" href="{% url 'my_preferences' %}">Preferencias</a>
        <a class="nav-link" href="{% url 'swap_requests' %}">Trocas</a>
        <a class="nav-link" href="{% url 'event_interest' %}">Eventos</a>
        {% if can_manage_parish %}
          <div class="pt-6 text-xs uppercase tracking-widest text-slate font-medium border-t border-black/10 mt-4">Administração</div>
          <a class="nav-link" href="{% url 'people_directory' %}">Pessoas</a>
          <a class="nav-link" href="{% url 'template_list' %}">Horarios fixos</a>
          <a class="nav-link" href="{% url 'event_series_list' %}">Programacao liturgica</a>
          <a class="nav-link" href="{% url 'roster_view' %}">Escala geral</a>
          <a class="nav-link" href="{% url 'scheduling_dashboard' %}">Escalonar</a>
          <a class="nav-link" href="{% url 'replacement_center' %}">Substituicoes</a>
          <a class="nav-link" href="{% url 'reports_frequency' %}">Relatorios</a>
          <a class="nav-link" href="{% url 'audit_log' %}">Auditoria</a>
          <div class="pt-4 text-xs uppercase tracking-widest text-slate font-medium border-t border-black/10 mt-4">Estrutura</div>
          <a class="nav-link" href="{% url 'structure_communities_list' %}">Comunidades</a>
          <a class="nav-link" href="{% url 'structure_roles_list' %}">Funcoes na escala</a>
          <a class="nav-link" href="{% url 'structure_requirement_profiles_list' %}">Perfis de requisitos</a>
          <a class="nav-link" href="{% url 'parish_settings' %}">Configuracoes</a>
        {% endif %}
      </nav>

      <main>
        <!-- Toast Notifications Container -->
        <div id="toast-container" class="fixed top-24 right-6 z-50 space-y-2 pointer-events-none">
          <!-- Toasts will be injected here -->
        </div>

        {% block content %}{% endblock %}
      </main>
    </div>

    <nav class="fixed bottom-0 inset-x-0 bg-white/90 backdrop-blur-md border-t border-black/12 flex sm:hidden justify-around py-4 text-xs shadow-soft rounded-t-2xl">
      <a href="{% url 'dashboard' %}" class="flex flex-col items-center gap-1 px-4 py-2 rounded-xl transition-all duration-200 hover:bg-sand/50">
        <span class="font-medium text-ink">Painel</span>
      </a>
      <a href="{% url 'calendar_month' %}" class="flex flex-col items-center gap-1 px-4 py-2 rounded-xl transition-all duration-200 hover:bg-sand/50">
        <span class="font-medium text-ink">Calendario</span>
      </a>
      <a href="{% url 'my_assignments' %}" class="flex flex-col items-center gap-1 px-4 py-2 rounded-xl transition-all duration-200 hover:bg-sand/50">
        <span class="font-medium text-ink">Escalas</span>
      </a>
      <a href="{% url 'swap_requests' %}" class="flex flex-col items-center gap-1 px-4 py-2 rounded-xl transition-all duration-200 hover:bg-sand/50">
        <span class="font-medium text-ink">Trocas</span>
      </a>
    </nav>
   </div>

   <!-- Global Confirmation Modal -->
   <div id="confirm-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
     <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
       <div class="fixed inset-0 bg-ink/40 backdrop-blur-sm transition-opacity" aria-hidden="true" onclick="window.closeConfirmModal()"></div>
       <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
       <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-soft transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full border border-black/5">
         <div class="bg-white px-6 pt-6 pb-4">
           <div class="sm:flex sm:items-start">
             <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
               <h3 class="text-lg font-semibold text-ink-900 mb-2" id="modal-title">
                 <!-- Title will be injected -->
               </h3>
               <div class="mt-2">
                 <p class="text-sm text-slate" id="modal-body">
                   <!-- Message will be injected -->
                 </p>
               </div>
             </div>
           </div>
         </div>
         <div class="bg-sand-50 px-6 py-4 sm:flex sm:flex-row-reverse gap-3">
           <button type="button" id="modal-confirm-btn" class="btn-primary w-full sm:w-auto">
             Confirmar
           </button>
           <button type="button" onclick="window.closeConfirmModal()" class="btn-secondary w-full sm:w-auto mt-3 sm:mt-0">
             Cancelar
           </button>
         </div>
       </div>
     </div>
   </div>

   <script>
     // ===== Toast Notification System =====
     window.showToast = function(message, type = 'success') {
       const container = document.getElementById('toast-container');
       const toast = document.createElement('div');
       
       const bgColors = {
         success: 'bg-moss-50 border-moss-200 text-moss-800',
         error: 'bg-red-50 border-red-200 text-red-800',
         warning: 'bg-sun-50 border-sun-200 text-sun-800',
         info: 'bg-slate-50 border-slate-200 text-slate-800'
       };
       
       toast.className = `pointer-events-auto transform transition-all duration-300 ease-out translate-x-full opacity-0 rounded-xl border ${bgColors[type] || bgColors.success} px-4 py-3 text-sm shadow-soft backdrop-blur-sm max-w-sm`;
       toast.textContent = message;
       
       container.appendChild(toast);
       
       // Trigger animation
       requestAnimationFrame(() => {
         requestAnimationFrame(() => {
           toast.classList.remove('translate-x-full', 'opacity-0');
         });
       });
       
       // Auto dismiss after 4 seconds
       setTimeout(() => {
         toast.classList.add('translate-x-full', 'opacity-0');
         setTimeout(() => toast.remove(), 300);
       }, 4000);
     };

     // ===== Confirmation Modal System =====
     window.showConfirmModal = function(message, onConfirm, title = 'Confirmar ação') {
       const modal = document.getElementById('confirm-modal');
       const modalTitle = document.getElementById('modal-title');
       const modalBody = document.getElementById('modal-body');
       const confirmBtn = document.getElementById('modal-confirm-btn');
       
       modalTitle.textContent = title;
       modalBody.textContent = message;
       
       // Remove old listeners by cloning the button
       const newConfirmBtn = confirmBtn.cloneNode(true);
       confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
       
       newConfirmBtn.addEventListener('click', function() {
         window.closeConfirmModal();
         onConfirm();
       });
       
       modal.classList.remove('hidden');
       document.body.style.overflow = 'hidden';
     };

     window.closeConfirmModal = function() {
       const modal = document.getElementById('confirm-modal');
       modal.classList.add('hidden');
       document.body.style.overflow = '';
     };

     // Close modal on ESC key
     document.addEventListener('keydown', function(e) {
       if (e.key === 'Escape') {
         window.closeConfirmModal();
       }
     });

     // ===== HTMX Confirmation Integration =====
     document.addEventListener('htmx:confirm', function(e) {
       e.preventDefault();
       const message = e.detail.question || 'Tem certeza que deseja realizar esta ação?';
       
       window.showConfirmModal(message, function() {
         e.detail.issueRequest(true);
       });
     });

     // ===== HTMX Success Flash Effect =====
     document.addEventListener('htmx:afterSwap', function(e) {
       // Check if response has success message header
       const successMsg = e.detail.xhr.getResponseHeader('HX-Success-Message');
       if (successMsg) {
         window.showToast(successMsg, 'success');
       }
       
       // Flash effect on updated elements
       const target = e.detail.target;
       if (target && e.detail.successful) {
         target.classList.add('htmx-success-flash');
         setTimeout(() => target.classList.remove('htmx-success-flash'), 1000);
       }
     });

     // ===== Custom Select Functionality =====
     document.addEventListener('DOMContentLoaded', function() {
       document.querySelectorAll('.custom-select').forEach(function(select) {
         const button = select.querySelector('.custom-select-button');
         const options = select.querySelector('.custom-select-options');
         const hiddenInput = select.querySelector('input[type="hidden"]');

         button.addEventListener('click', function(e) {
           e.preventDefault();
           select.classList.toggle('open');
         });

         select.querySelectorAll('.custom-select-option').forEach(function(option) {
           option.addEventListener('click', function() {
             const value = this.getAttribute('data-value');
             const text = this.textContent.trim();

             // Update button text
             button.querySelector('.selected-text').textContent = text;

             // Update hidden input
             if (hiddenInput) {
               hiddenInput.value = value;
             }

             // Update selected state
             select.querySelectorAll('.custom-select-option').forEach(function(opt) {
               opt.classList.remove('selected');
             });
             this.classList.add('selected');

             // Close dropdown
             select.classList.remove('open');
           });
         });
       });

       // Close dropdowns when clicking outside
       document.addEventListener('click', function(e) {
         if (!e.target.closest('.custom-select')) {
           document.querySelectorAll('.custom-select.open').forEach(function(select) {
             select.classList.remove('open');
           });
         }
       });
     });
   </script>
</body>
</html>
