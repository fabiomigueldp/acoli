{% extends 'base.html' %}
{% load extras %}
{% block title %}Calendario{% endblock %}
{% block content %}
<div class="grid gap-6">
  <div class="card">
    <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
      <div>
        <h2 class="font-serif text-2xl text-moss">{{ month }}/{{ year }}</h2>
        <p class="text-sm text-slate">Visualização mensal do calendário litúrgico</p>
      </div>
      <div class="flex items-center gap-3">
        <a class="btn-secondary" href="?year={{ prev_month.year }}&month={{ prev_month.month }}">
          <span class="hidden sm:inline">Anterior</span>
          <span class="sm:hidden">←</span>
        </a>
        <div class="px-4 py-2 bg-sand/50 rounded-xl text-sm font-medium text-ink">
          {{ month }}/{{ year }}
        </div>
        <a class="btn-secondary" href="?year={{ next_month.year }}&month={{ next_month.month }}">
          <span class="hidden sm:inline">Próximo</span>
          <span class="sm:hidden">→</span>
        </a>
      </div>
    </div>
    <form method="get" class="grid sm:grid-cols-4 gap-4">
      <input type="hidden" name="year" value="{{ year }}" />
      <input type="hidden" name="month" value="{{ month }}" />
       <div>
         <label class="label">Comunidade</label>
         <div class="custom-select">
           <input type="hidden" name="community" value="{{ filters.community }}">
           <button type="button" class="custom-select-button">
             <span class="selected-text">
               {% if filters.community %}
                 {% for community in communities %}
                   {% if filters.community == community.id|stringformat:"s" %}{{ community.code }}{% endif %}
                 {% endfor %}
               {% else %}
                 Todas
               {% endif %}
             </span>
           </button>
           <div class="custom-select-options">
             <button type="button" class="custom-select-option {% if not filters.community %}selected{% endif %}" data-value="">Todas</button>
             {% for community in communities %}
               <button type="button" class="custom-select-option {% if filters.community == community.id|stringformat:"s" %}selected{% endif %}" data-value="{{ community.id }}">{{ community.code }}</button>
             {% endfor %}
           </div>
         </div>
       </div>
       <div>
         <label class="label">Status</label>
         <div class="custom-select">
           <input type="hidden" name="status" value="{{ filters.status }}">
           <button type="button" class="custom-select-button">
             <span class="selected-text">
               {% if filters.status == "scheduled" %}Agendado{% elif filters.status == "canceled" %}Cancelado{% else %}Todos os status{% endif %}
             </span>
           </button>
           <div class="custom-select-options">
             <button type="button" class="custom-select-option {% if not filters.status %}selected{% endif %}" data-value="">Todos os status</button>
             <button type="button" class="custom-select-option {% if filters.status == "scheduled" %}selected{% endif %}" data-value="scheduled">Agendado</button>
             <button type="button" class="custom-select-option {% if filters.status == "canceled" %}selected{% endif %}" data-value="canceled">Cancelado</button>
           </div>
         </div>
       </div>
       <div>
         <label class="label">Tipo</label>
         <div class="custom-select">
           <input type="hidden" name="kind" value="{{ filters.kind }}">
           <button type="button" class="custom-select-button">
             <span class="selected-text">
               {% if filters.kind == "template" %}Recorrente{% elif filters.kind == "event" %}Evento único{% else %}Todos os tipos{% endif %}
             </span>
           </button>
           <div class="custom-select-options">
             <button type="button" class="custom-select-option {% if not filters.kind %}selected{% endif %}" data-value="">Todos os tipos</button>
             <button type="button" class="custom-select-option {% if filters.kind == "template" %}selected{% endif %}" data-value="template">Recorrente</button>
             <button type="button" class="custom-select-option {% if filters.kind == "event" %}selected{% endif %}" data-value="event">Evento único</button>
           </div>
         </div>
       </div>
      <div class="flex items-end">
        <button class="btn-primary w-full">Aplicar filtros</button>
      </div>
    </form>
  </div>

  <div class="card lg:hidden">
    <div class="mb-6">
      <h3 class="font-semibold text-lg text-ink">Eventos do mês</h3>
      <p class="text-sm text-slate">Lista completa para dispositivos móveis</p>
    </div>
    <div class="space-y-4">
      {% for instance in instances %}
        <a class="block border border-black/8 rounded-xl p-4 hover:bg-sand/40 hover:border-moss/20 transition-all duration-200 hover:shadow-sm group {% if instance.id in my_confirmed_ids %}bg-moss-50/70 border-moss-200{% elif instance.id in my_pending_ids %}bg-sun-50/70 border-sun-200{% elif instance.id in pending_confirmation_ids %}bg-sun-50/30 border-sun-200{% endif %}" href="{% url 'mass_detail' instance.id %}">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-slate rounded-full flex items-center justify-center text-white font-serif text-sm font-bold">
                {{ instance.community.code|slice:":1" }}
              </div>
              <div>
                <div class="text-sm text-slate font-medium">{{ instance.starts_at|date:"D, d/m" }}</div>
                <div class="font-semibold text-ink group-hover:text-moss transition-colors">{{ instance.starts_at|date:"H:i" }} • {{ instance.community.code }}</div>
              </div>
            </div>
            <div class="text-right">
              <span class="badge">{{ instance.status|mass_status_label }}</span>
            </div>
          </div>
          <div class="text-sm text-slate ml-13">{{ instance.liturgy_label|default:"Missa" }}</div>
        </a>
      {% empty %}
        <div class="text-center py-8">
          <div class="w-16 h-16 bg-sand rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-slate" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-5.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H3"></path>
            </svg>
          </div>
          <p class="text-slate font-medium">Nenhum evento encontrado</p>
          <p class="text-sm text-slate mt-1">Tente ajustar os filtros ou navegar para outro mês.</p>
        </div>
      {% endfor %}
    </div>
  </div>

  <div class="card hidden lg:block">
    <div class="grid grid-cols-7 text-xs uppercase tracking-widest text-slate font-medium mb-4">
      <div class="p-3 text-center">Dom</div>
      <div class="p-3 text-center">Seg</div>
      <div class="p-3 text-center">Ter</div>
      <div class="p-3 text-center">Qua</div>
      <div class="p-3 text-center">Qui</div>
      <div class="p-3 text-center">Sex</div>
      <div class="p-3 text-center">Sáb</div>
    </div>
    <div class="grid grid-cols-7 gap-1 bg-sand/30 rounded-xl p-1">
      {% for week in month_grid %}
        {% for day in week %}
          <div class="bg-white min-h-[140px] p-3 rounded-lg {% if day.month != month %}opacity-40{% endif %} hover:shadow-sm transition-all duration-200">
            <div class="text-sm font-medium text-ink mb-2">{{ day|date:"d" }}</div>
            <div class="space-y-2">
              {% for instance in instances_by_day|get_list_item:day %}
                <a class="block text-xs rounded-lg border border-black/8 px-3 py-2 hover:bg-moss/5 hover:border-moss/20 transition-all duration-200 group {% if instance.id in my_confirmed_ids %}bg-moss-50/70 border-moss-200{% elif instance.id in my_pending_ids %}bg-sun-50/70 border-sun-200{% elif instance.id in pending_confirmation_ids %}bg-sun-50/30 border-sun-200{% endif %}" href="{% url 'mass_detail' instance.id %}">
                  <div class="font-semibold text-ink group-hover:text-moss transition-colors">{{ instance.starts_at|date:"H:i" }}</div>
                  <div class="text-slate font-medium">{{ instance.community.code }}</div>
                  <div class="text-slate text-xs mt-0.5">{{ instance.liturgy_label|default:"Missa" }}</div>
                </a>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}
