{% extends 'base.html' %}
{% load extras %}
{% block title %}Detalhe da missa{% endblock %}
{% block content %}
<div class="grid gap-6">
  <div class="card">
    <div class="text-sm text-slate">{{ instance.starts_at|date:"d/m/Y H:i" }}</div>
    <h2 class="font-serif text-2xl">{{ instance.community.name }}</h2>
    <p class="text-slate">{{ instance.liturgy_label|default:"Missa" }}</p>
    <div class="mt-4 flex items-center gap-2">
      <span class="badge">{{ instance.status }}</span>
      {% if instance.event_series %}
        <span class="badge">Evento</span>
      {% endif %}
    </div>
  </div>

  {% if can_manage_parish %}
    <div class="grid lg:grid-cols-3 gap-4">
      <div class="card">
        <h3 class="font-semibold mb-3">Editar informacoes</h3>
        <form method="post" action="{% url 'mass_update' instance.id %}" class="space-y-3">
          {% csrf_token %}
          <div>
            <label class="label">Rotulo</label>
            {{ update_form.liturgy_label }}
          </div>
           <div>
             <label class="label">Perfil de requisitos</label>
             <div class="custom-select">
               <input type="hidden" name="requirement_profile" value="{{ update_form.requirement_profile.value }}">
               <button type="button" class="custom-select-button">
                 <span class="selected-text">
                   {% if update_form.requirement_profile.value %}
                     {% for choice_value, choice_label in update_form.requirement_profile.field.choices %}
                       {% if update_form.requirement_profile.value == choice_value %}{{ choice_label }}{% endif %}
                     {% endfor %}
                   {% else %}
                     Selecionar...
                   {% endif %}
                 </span>
               </button>
               <div class="custom-select-options">
                 {% for choice_value, choice_label in update_form.requirement_profile.field.choices %}
                   <button type="button" class="custom-select-option {% if update_form.requirement_profile.value == choice_value %}selected{% endif %}" data-value="{{ choice_value }}">{{ choice_label }}</button>
                 {% endfor %}
               </div>
             </div>
           </div>
          <button class="btn-secondary" type="submit">Salvar</button>
        </form>
      </div>
      <div class="card">
        <h3 class="font-semibold mb-3">Mover missa</h3>
        <form method="post" action="{% url 'mass_move' instance.id %}" class="space-y-3">
          {% csrf_token %}
          <div>
            <label class="label">Nova data/hora</label>
            {{ move_form.starts_at }}
          </div>
           <div>
             <label class="label">Nova comunidade</label>
             <div class="custom-select">
               <input type="hidden" name="community" value="{{ move_form.community.value }}">
               <button type="button" class="custom-select-button">
                 <span class="selected-text">
                   {% if move_form.community.value %}
                     {% for choice_value, choice_label in move_form.community.field.choices %}
                       {% if move_form.community.value == choice_value %}{{ choice_value }}{% endif %}
                     {% endfor %}
                   {% else %}
                     Selecionar...
                   {% endif %}
                 </span>
               </button>
               <div class="custom-select-options">
                 {% for choice_value, choice_label in move_form.community.field.choices %}
                   <button type="button" class="custom-select-option {% if move_form.community.value == choice_value %}selected{% endif %}" data-value="{{ choice_value }}">{{ choice_value }}</button>
                 {% endfor %}
               </div>
             </div>
           </div>
          <button class="btn-secondary" type="submit">Mover</button>
        </form>
      </div>
      <div class="card">
        <h3 class="font-semibold mb-3">Cancelar</h3>
        <form method="post" action="{% url 'mass_cancel' instance.id %}" class="space-y-3" onsubmit="return confirm('Tem certeza que deseja cancelar esta missa?');">
          {% csrf_token %}
          <div>
            <label class="label">Motivo (opcional)</label>
            {{ cancel_form.reason }}
          </div>
          <button class="btn-primary" type="submit">Cancelar missa</button>
        </form>
      </div>
    </div>
  {% endif %}

  <div class="card">
    <h3 class="font-semibold mb-3">Funcoes</h3>
    <div class="space-y-2">
      {% for slot in slots %}
        <div class="border border-black/5 rounded-lg p-3 space-y-3">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="text-sm text-slate">{{ slot.position_type.name }}</div>
              {% if slot.externally_covered %}
                <div class="font-medium">Coberto externamente</div>
                {% if slot.external_coverage_notes %}
                  <div class="text-xs text-slate">{{ slot.external_coverage_notes }}</div>
                {% endif %}
              {% elif not slot.required %}
                <div class="font-medium">Nao necessario</div>
              {% else %}
                {% with active=slot.active_assignment %}
                  <div class="font-medium">{% if active %}{{ active.acolyte.display_name }}{% else %}Vaga aberta{% endif %}</div>
                {% endwith %}
              {% endif %}
              {% if slot.recent_assignments and slot.recent_assignments|length > 1 %}
                <div class="text-xs text-slate mt-2">
                  <div class="uppercase tracking-wide text-slate">Historico recente</div>
                  <div class="space-y-1">
                    {% for past in slot.recent_assignments %}
                      {% if not past.is_active %}
                        <div>{{ past.acolyte.display_name }}{% if past.end_reason %} ({{ past.end_reason }}){% endif %}</div>
                      {% endif %}
                    {% endfor %}
                  </div>
                </div>
              {% endif %}
            </div>
            <span class="badge">{{ slot.status }}</span>
          </div>
          {% if can_manage_parish and slot.required and not slot.externally_covered %}
            {% with active=slot.active_assignment %}
              <div class="flex flex-wrap items-center gap-2">
                {% for candidate in slot_suggestions|get_list_item:slot.id %}
                  <form method="post" action="{% if active %}{% url 'slot_replace' instance.id slot.id %}{% else %}{% url 'slot_assign' instance.id slot.id %}{% endif %}"{% if slot.is_locked %} onsubmit="return confirm('Esta missa esta consolidada. Deseja continuar?')"{% endif %}>
                    {% csrf_token %}
                    <input type="hidden" name="acolyte_id" value="{{ candidate.id }}" />
                    <button class="btn-secondary" type="submit">{% if active %}Substituir{% else %}Atribuir{% endif %} {{ candidate.display_name }}</button>
                  </form>
                {% empty %}
                  <span class="text-xs text-slate">Sem sugestoes automaticas.</span>
                {% endfor %}
                <a class="btn-secondary" href="{% url 'slot_assign' instance.id slot.id %}">Escolher outro</a>
              </div>
            {% endwith %}
          {% endif %}
        </div>
      {% empty %}
        <p class="text-sm text-slate">Sem slots configurados.</p>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}
