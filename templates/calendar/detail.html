{% extends 'base.html' %}
{% load extras %}
{% block title %}Detalhe da missa{% endblock %}
{% block content %}
<div class="grid gap-6">
  <div class="card">
    <div class="text-sm text-slate">{{ instance.starts_at|date:"d/m/Y H:i" }}</div>
    <h2 class="font-serif text-2xl">{{ instance.community.name }}</h2>
    <p class="text-slate">{{ instance.liturgy_label|default:"Missa" }}</p>
    <div class="mt-4 flex items-center gap-2">
      <span class="badge">{{ instance.status|mass_status_label }}</span>
      {% if instance.event_series %}
        <span class="badge">Evento</span>
      {% endif %}
    </div>
  </div>

  {% if can_manage_parish %}
    <div class="grid lg:grid-cols-3 gap-4">
      <div class="card">
        <h3 class="font-semibold mb-3">Editar informacoes</h3>
        <form method="post" action="{% url 'mass_update' instance.id %}" class="space-y-3">
          {% csrf_token %}
          <div>
            <label class="label">Rotulo</label>
            {{ update_form.liturgy_label }}
          </div>
           <div>
             <label class="label">Perfil de requisitos</label>
             <div class="custom-select">
               <input type="hidden" name="requirement_profile" value="{{ update_form.requirement_profile.value }}">
               <button type="button" class="custom-select-button">
                 <span class="selected-text">
                   {% if update_form.requirement_profile.value %}
                     {% for choice_value, choice_label in update_form.requirement_profile.field.choices %}
                       {% if update_form.requirement_profile.value == choice_value %}{{ choice_label }}{% endif %}
                     {% endfor %}
                   {% else %}
                     Selecionar...
                   {% endif %}
                 </span>
               </button>
               <div class="custom-select-options">
                 {% for choice_value, choice_label in update_form.requirement_profile.field.choices %}
                   <button type="button" class="custom-select-option {% if update_form.requirement_profile.value == choice_value %}selected{% endif %}" data-value="{{ choice_value }}">{{ choice_label }}</button>
                 {% endfor %}
               </div>
             </div>
           </div>
          <button class="btn-secondary w-full sm:w-auto" type="submit">Salvar</button>
        </form>
      </div>
      <div class="card">
        <h3 class="font-semibold mb-3">Mover missa</h3>
        <form method="post" action="{% url 'mass_move' instance.id %}" class="space-y-3">
          {% csrf_token %}
          <div>
            <label class="label">Nova data/hora</label>
            {{ move_form.starts_at }}
          </div>
           <div>
             <label class="label">Nova comunidade</label>
             <div class="custom-select">
               <input type="hidden" name="community" value="{{ move_form.community.value }}">
               <button type="button" class="custom-select-button">
                  <span class="selected-text">
                    {% if move_form.community.value %}
                      {% for choice_value, choice_label in move_form.community.field.choices %}
                        {% if move_form.community.value == choice_value %}{{ choice_label|slice:":3" }}{% endif %}
                      {% endfor %}
                    {% else %}
                      Selecionar...
                    {% endif %}
                  </span>
               </button>
               <div class="custom-select-options">
                  {% for choice_value, choice_label in move_form.community.field.choices %}
                    <button type="button" class="custom-select-option {% if move_form.community.value == choice_value %}selected{% endif %}" data-value="{{ choice_value }}">{{ choice_label|slice:":3" }}</button>
                  {% endfor %}
               </div>
             </div>
           </div>
          <button class="btn-secondary w-full sm:w-auto" type="submit">Mover</button>
        </form>
      </div>
      <div class="card">
        <h3 class="font-semibold mb-3">Cancelar</h3>
        <form method="post" action="{% url 'mass_cancel' instance.id %}" class="space-y-3" onsubmit="return confirm('Tem certeza que deseja cancelar esta missa?');">
          {% csrf_token %}
          <div>
            <label class="label">Motivo (opcional)</label>
            {{ cancel_form.reason }}
          </div>
          <button class="btn-primary w-full sm:w-auto" type="submit">Cancelar missa</button>
        </form>
      </div>
    </div>
  {% endif %}

  {% include 'calendar/_slots_section.html' %}
</div>
{% if show_conflict_modal %}
  {% include 'modals/assignment_conflict.html' %}
{% endif %}
{% endblock %}
