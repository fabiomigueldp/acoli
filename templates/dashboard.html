{% extends 'base.html' %}
{% block title %}Painel{% endblock %}
{% block content %}
{% if no_parishes %}
  <div class="card">
    <h2 class="font-serif text-xl mb-2">Nenhuma paroquia cadastrada</h2>
    <p class="text-sm text-slate mb-3">Crie uma paroquia para comecar a operar o sistema.</p>
    <a class="btn-secondary" href="/admin/">Abrir Django admin</a>
  </div>
{% elif missing_parish %}
  <div class="card">Nenhuma paroquia ativa. Contate o administrador.</div>
{% else %}
  {% if dashboard_view == "admin" %}
    <!-- Admin View -->
    <div class="space-y-8">
      <!-- Risk Radar -->
      <div class="md:hidden -mx-4 px-4 pb-2">
        <div class="flex gap-3 overflow-x-auto snap-x snap-mandatory">
          <div class="card text-center min-w-[160px] snap-center">
            <div class="text-3xl font-serif text-moss mb-1">{{ open_slots_count }}</div>
            <div class="text-xs text-ink font-medium">Vagas abertas</div>
            <div class="text-xs text-slate mt-1">14 dias</div>
          </div>
          <div class="card text-center min-w-[160px] snap-center">
            <div class="text-3xl font-serif text-moss mb-1">{{ pending_replacements }}</div>
            <div class="text-xs text-ink font-medium">Substituicoes</div>
            <div class="text-xs text-slate mt-1">Pendentes</div>
          </div>
          <div class="card text-center min-w-[160px] snap-center">
            <div class="text-3xl font-serif text-moss mb-1">{{ pending_swaps }}</div>
            <div class="text-xs text-ink font-medium">Trocas</div>
            <div class="text-xs text-slate mt-1">Pendentes</div>
          </div>
        </div>
      </div>
      <div class="hidden md:grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="card text-center">
          <div class="text-4xl font-serif text-moss mb-2">{{ open_slots_count }}</div>
          <div class="text-sm text-ink font-medium">Vagas abertas (14 dias)</div>
          <div class="text-xs text-slate mt-1">Posicoes essenciais ainda vazias</div>
        </div>
        <div class="card text-center">
          <div class="text-4xl font-serif text-moss mb-2">{{ pending_replacements }}</div>
          <div class="text-sm text-ink font-medium">Substituicoes pendentes</div>
          <div class="text-xs text-slate mt-1">Solicitacoes de reposicao aguardando</div>
        </div>
        <div class="card text-center">
          <div class="text-4xl font-serif text-moss mb-2">{{ pending_swaps }}</div>
          <div class="text-sm text-ink font-medium">Trocas pendentes</div>
          <div class="text-xs text-slate mt-1">Solicitacoes de troca aguardando aprovacao</div>
        </div>
       </div>

       <!-- Pending Swap Approvals -->
       {% if pending_swap_approvals %}
       <div class="card">
         <div class="mb-6">
           <h3 class="text-xl font-serif text-moss">Trocas aguardando aprovação</h3>
           <p class="text-sm text-slate mt-2">Trocas aceitas pelos acólitos que precisam da sua aprovação para serem efetivadas.</p>
         </div>
         <div class="space-y-3">
            {% for swap in pending_swap_approvals %}
              <div id="dashboard-swap-{{ swap.id }}" class="flex items-start justify-between gap-4 p-4 border border-sand-200 rounded-lg">
                <div class="flex-1 min-w-0">
                  <div class="text-sm text-ink-600 mb-1">
                    {{ swap.mass_instance.starts_at|date:"H:i" }} · {{ swap.mass_instance.community.short_name|default:swap.mass_instance.community.name }} · {{ swap.mass_instance.starts_at|date:"d/m/Y" }}
                  </div>
                  <div class="text-base font-medium text-ink mb-1">
                    {% if swap.swap_type == "role_swap" %}
                      Trocar {{ swap.from_slot.position_type.name }} → {{ swap.to_slot.position_type.name }}
                    {% else %}
                      Troca de acólito
                    {% endif %}
                  </div>
                  <div class="text-sm text-ink-600">
                    Aprovado por {{ swap.target_acolyte.user.full_name|default:swap.target_acolyte.display_name }} · Solicitado por {{ swap.requestor_acolyte.user.full_name|default:swap.requestor_acolyte.display_name }}
                  </div>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                  <button
                    hx-post="{% url 'swap_request_approve' swap.id %}"
                    hx-target="#dashboard-swap-{{ swap.id }}"
                    hx-swap="outerHTML"
                    class="btn-primary text-sm px-3 py-2 w-full sm:w-auto">
                    Aprovar
                  </button>
                  <button
                    hx-post="{% url 'swap_request_cancel' swap.id %}"
                    hx-target="#dashboard-swap-{{ swap.id }}"
                    hx-swap="outerHTML"
                    hx-confirm="Tem certeza que deseja cancelar esta troca?"
                    class="btn-danger text-sm px-3 py-2 w-full sm:w-auto">
                    Cancelar
                  </button>
                </div>
              </div>
           {% empty %}
             <div class="text-center py-6 text-slate">Nenhuma troca aguardando aprovação</div>
           {% endfor %}
         </div>
         <div class="mt-4 text-center">
           <a href="{% url 'swap_requests' %}?all=true" class="text-sm text-ink-600 hover:text-ink-800 underline">Ver todas as trocas</a>
         </div>
       </div>
       {% endif %}

       <!-- Upcoming Masses -->
      <div class="card">
        <div class="mb-6">
          <h3 class="text-xl font-serif text-moss">Proximas missas</h3>
          <p class="text-sm text-slate mt-2">Alertas de escala incompleta e confirmacoes pendentes.</p>
        </div>
        <div class="space-y-4">
          {% for mass in upcoming_masses %}
            <a href="{% url 'mass_detail' mass.id %}" class="group block rounded-xl border border-black/5 bg-white/80 p-5 transition-all hover:bg-white hover:shadow-soft">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="space-y-2">
                  <div class="text-xs uppercase tracking-wide text-slate">{{ mass.starts_at|date:"l, d/m/Y" }}</div>
                  <div class="text-base font-medium text-ink">{{ mass.community.code }} - {{ mass.liturgy_label|default:"Missa" }}</div>
                  <div class="flex flex-wrap gap-x-4 gap-y-2 text-xs text-slate">
                    {% if mass.open_slots_count %}
                      <div class="flex items-center gap-2">
                        <span class="h-2 w-2 rounded-full bg-sun"></span>
                        <span>Escala incompleta: <span class="font-medium text-ink">{{ mass.open_slots_count }} vaga{{ mass.open_slots_count|pluralize }}</span></span>
                      </div>
                    {% endif %}
                    {% if mass.active_assignments_count %}
                      <div class="flex items-center gap-2">
                        <span class="h-2 w-2 rounded-full bg-moss"></span>
                        <span>Confirmacoes: <span class="font-medium text-ink">{{ mass.confirmed_assignments_count }}/{{ mass.active_assignments_count }}</span></span>
                      </div>
                    {% else %}
                      <div class="flex items-center gap-2">
                        <span class="h-2 w-2 rounded-full bg-slate"></span>
                        <span>Sem acolitos escalados</span>
                      </div>
                    {% endif %}
                    {% if mass.pending_confirmations_count %}
                      <div class="flex items-center gap-2">
                        <span class="h-2 w-2 rounded-full bg-sun"></span>
                        <span>Confirmacoes pendentes: <span class="font-medium text-ink">{{ mass.pending_confirmations_count }}</span></span>
                      </div>
                    {% endif %}
                    {% if mass.is_soon and mass.open_slots_count %}
                      <div class="flex items-center gap-2">
                        <span class="h-2 w-2 rounded-full bg-sun"></span>
                        <span class="font-medium text-ink">Missa proxima sem escala</span>
                      </div>
                    {% endif %}
                  </div>
                </div>
                <div class="text-2xl font-serif text-moss">{{ mass.starts_at|date:"H:i" }}</div>
              </div>
            </a>
          {% empty %}
            <div class="text-center py-8 text-slate">Nenhuma missa proxima agendada</div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% else %}
    <!-- Acolyte View -->
    <div class="space-y-8">

      <!-- Hero Assignment -->
      {% if hero_assignment %}
        {% include "acolytes/_partials/dashboard_hero_assignment.html" %}
      {% else %}
        <div class="rounded-2xl bg-white/80 p-10 text-center shadow-soft border border-white/70">
          <div class="text-lg text-ink font-medium">Nenhuma escala proxima</div>
          <div class="text-sm text-slate mt-2">Suas proximas atribuicoes aparecem aqui</div>
        </div>
      {% endif %}

      <!-- Pending Actions (Inbox) -->
      {% if pending_assignments or incoming_swaps %}
        <div class="rounded-2xl bg-sun-50/70 p-6 shadow-soft border border-sun-100">
          <div class="mb-6 space-y-2">
            <div class="text-xs uppercase tracking-[0.2em] text-slate">Acoes pendentes</div>
            <h2 class="font-serif text-2xl text-ink">Resolva antes de fechar</h2>
          </div>
          <div class="space-y-3">
            {% for assignment in pending_assignments %}
              {% include "acolytes/_partials/dashboard_pending_row.html" %}
            {% endfor %}
            {% for swap in incoming_swaps %}
              <div id="swap-{{ swap.id }}" class="flex flex-col gap-3 rounded-xl bg-white/80 px-4 py-4 sm:flex-row sm:items-center sm:justify-between">
                <div class="space-y-1">
                  <div class="text-sm text-slate">{{ swap.mass_instance.starts_at|date:"D, d M • H:i" }}</div>
                  <div class="text-base text-ink font-medium">Troca solicitada</div>
                  <div class="text-sm text-slate">{{ swap.requested_position.name }}</div>
                </div>
                <div class="flex w-full gap-2 sm:w-auto">
                  <button hx-post="{% url 'swap_request_accept' swap.id %}" hx-target="#swap-{{ swap.id }}" hx-swap="outerHTML" class="btn-primary flex-1 sm:flex-none">Aceitar</button>
                  <button hx-post="{% url 'swap_request_reject' swap.id %}" hx-target="#swap-{{ swap.id }}" hx-swap="outerHTML" class="btn-secondary flex-1 sm:flex-none">Recusar</button>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      <!-- Future Assignments (Horizon) -->
      {% if horizon_assignments %}
        <div class="rounded-2xl bg-white/80 p-6 shadow-soft border border-white/70">
          <div class="mb-6 flex items-center justify-between">
            <h2 class="font-serif text-2xl text-ink">Agenda futura</h2>
            <span class="text-xs uppercase tracking-[0.2em] text-slate">Proximas semanas</span>
          </div>
          <div class="divide-y divide-sand-100">
            {% for assignment in horizon_assignments %}
              <div class="flex flex-col gap-3 py-4 sm:flex-row sm:items-center sm:justify-between">
                <div class="flex items-center gap-4">
                  <div class="text-sm font-medium text-ink">{{ assignment.slot.mass_instance.starts_at|date:"d M" }}</div>
                  <div>
                    <div class="text-base text-ink font-medium">{{ assignment.slot.mass_instance.community.code }} - {{ assignment.slot.position_type.name }}</div>
                    <div class="text-sm text-slate">{{ assignment.slot.mass_instance.starts_at|date:"H:i" }}</div>
                  </div>
                </div>
                {% if assignment.confirmation_status == 'confirmed' %}
                  <span class="text-xs font-medium uppercase tracking-[0.2em] text-moss">Confirmado</span>
                {% else %}
                  <span class="text-xs font-medium uppercase tracking-[0.2em] text-sun">Pendente</span>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    </div>
  {% endif %}
{% endif %}
{% endblock %}
