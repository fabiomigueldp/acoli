{% extends 'base.html' %}
{% load extras %}
{% block title %}Substituicoes{% endblock %}
{% block content %}
<div class="grid gap-6">
  <div class="grid sm:grid-cols-3 gap-4">
    <div class="card">
      <div class="text-sm text-slate">Substituicoes pendentes</div>
      <div class="text-3xl font-serif">{{ pending_in_window }}</div>
    </div>
    <div class="card">
      <div class="text-sm text-slate">Vagas abertas (consolidacao)</div>
      <div class="text-3xl font-serif">{{ open_slots }}</div>
    </div>
    <div class="card">
      <div class="text-sm text-slate">Confirmacoes pendentes</div>
      <div class="text-3xl font-serif">{{ pending_confirmations }}</div>
    </div>
  </div>

  <div class="card">
    <div class="flex items-center justify-between mb-4">
      <h2 class="font-serif text-xl">Substituicoes pendentes</h2>
    </div>
    <div class="space-y-3">
      {% for item in replacements %}
        <div class="border border-black/5 rounded-xl p-4 space-y-3">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="text-sm text-slate">{{ item.slot.mass_instance.starts_at|date:"d/m H:i" }}</div>
              <div class="font-medium">{{ item.slot.mass_instance.community.code }} - {{ item.slot.position_type.name }}</div>
              <div class="text-xs text-slate mt-1">Em {{ item.slot.mass_instance.starts_at|timeuntil }}</div>
              {% if item.notes %}
                <div class="text-xs text-slate mt-1">{{ item.notes }}</div>
              {% endif %}
            </div>
            <div class="flex items-center gap-2">
              {% if item.slot.is_locked %}
                <span class="badge">Bloqueada</span>
              {% endif %}
              <span class="badge">Pendente</span>
            </div>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            {% for acolyte in suggestions|get_item:item.id %}
              <form method="post" action="{% url 'replacement_assign' item.id %}">
                {% csrf_token %}
                <input type="hidden" name="acolyte_id" value="{{ acolyte.id }}" />
                <button class="btn-secondary" type="submit">Atribuir {{ acolyte.display_name }}</button>
              </form>
            {% empty %}
              <span class="text-sm text-slate">Sem sugestoes automaticas.</span>
            {% endfor %}
            <a class="btn-secondary" href="{% url 'replacement_pick' item.id %}">Escolher outro</a>
            <a class="btn-secondary" href="{% url 'replacement_resolve' item.id %}">Marcar como resolvida</a>
          </div>
        </div>
      {% empty %}
        <p class="text-sm text-slate">Nenhuma substituicao pendente.</p>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}
