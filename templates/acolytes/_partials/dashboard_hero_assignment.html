{% load extras %}
{% if hero_assignment %}
  {% with claims=claims_by_slot|get_item:hero_assignment.slot_id %}
  <div id="assignment-{{ hero_assignment.id }}">
    <div class="md:hidden rounded-2xl bg-gradient-to-br from-sand-50 via-white to-moss-50/40 p-4 shadow-soft border border-white/70{% if hero_assignment.confirmation_status != 'confirmed' %} hero-attn{% endif %}">
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <div class="text-xs uppercase tracking-[0.2em] text-slate">Sua proxima escala</div>
          <div class="text-lg font-serif text-ink">{{ hero_assignment.slot.mass_instance.starts_at|date:"l, d M" }}</div>
          <div class="text-2xl font-serif text-ink">{{ hero_assignment.slot.mass_instance.starts_at|date:"H:i" }}</div>
          <div class="flex flex-wrap items-center gap-2 mt-2">
            <div class="text-sm text-slate">{{ hero_assignment.slot.mass_instance.community.code }}</div>
            <div class="inline-flex items-center justify-center rounded-full bg-moss-100 px-2.5 py-1 text-xs font-medium text-ink">
              {{ hero_assignment.slot.position_type.name }}
            </div>
          </div>
        </div>
        {% if hero_assignment.confirmation_status == 'confirmed' %}
          <span class="text-xs font-medium uppercase tracking-[0.2em] text-moss">Confirmado</span>
        {% endif %}
      </div>

      {% if claims %}
        <div class="mt-4 rounded-xl bg-white/70 px-3 py-3">
          <div class="text-xs uppercase tracking-[0.2em] text-slate">Solicitacoes de posicao</div>
          <div class="mt-2 space-y-2">
            {% for claim in claims %}
              <div class="flex items-center justify-between gap-3">
                <span class="text-sm text-ink">{{ claim.requestor_acolyte.display_name }}</span>
                <button
                  hx-post="{% url 'position_claim_choose' claim.id %}"
                  hx-target="#assignment-{{ hero_assignment.id }}"
                  hx-swap="outerHTML"
                  hx-vals='{"return": "dashboard_hero"}'
                  class="btn-secondary btn-compact"
                  type="button">
                  Ceder
                </button>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      <div class="mt-4 flex flex-col gap-2">
        {% if hero_assignment.confirmation_status != 'confirmed' %}
          <button
            hx-post="{% url 'confirm_assignment' hero_assignment.id %}"
            hx-target="#assignment-{{ hero_assignment.id }}"
            hx-swap="outerHTML"
            hx-vals='{"return": "dashboard_hero"}'
            class="btn-primary w-full"
            type="button">
            Confirmar presenca
          </button>
          <button
            hx-post="{% url 'decline_assignment' hero_assignment.id %}"
            hx-target="#assignment-{{ hero_assignment.id }}"
            hx-swap="outerHTML"
            hx-vals='{"return": "dashboard_hero"}'
            hx-confirm="Tem certeza que deseja recusar esta escala?"
            class="btn-link w-full"
            type="button">
            Nao posso ir
          </button>
        {% else %}
          {% if hero_has_swap_options %}
            <a href="{% url 'swap_request_create' hero_assignment.id %}" class="btn-secondary w-full text-center">Solicitar troca</a>
          {% endif %}
        {% endif %}
      </div>
    </div>

    <div class="hidden md:block rounded-2xl bg-gradient-to-br from-sand-50 via-white to-moss-50/40 p-6 sm:p-8 shadow-soft border border-white/70{% if hero_assignment.confirmation_status != 'confirmed' %} hero-attn{% endif %}">
      <div class="flex flex-col gap-6 md:flex-row md:items-start md:justify-between">
        <div class="space-y-3">
          <div class="text-xs uppercase tracking-[0.2em] text-slate">Sua proxima escala</div>
          <div class="text-2xl sm:text-3xl font-serif text-ink">{{ hero_assignment.slot.mass_instance.starts_at|date:"l, d M" }}</div>
          <div class="text-4xl lg:text-5xl font-serif text-ink">{{ hero_assignment.slot.mass_instance.starts_at|date:"H:i" }}</div>
          <div class="flex items-center gap-2">
            <div class="text-base text-slate">{{ hero_assignment.slot.mass_instance.community.code }}</div>
            <div class="inline-flex items-center justify-center rounded-full bg-moss-100 px-3 py-1 text-sm font-medium text-ink">
              {{ hero_assignment.slot.position_type.name }}
            </div>
          </div>
        </div>
        <div class="flex w-full flex-col gap-4 md:w-auto md:min-w-[280px]">
          {% if claims %}
            <div class="rounded-lg bg-white/70 px-3 py-3">
              <div class="text-xs uppercase tracking-[0.2em] text-slate">Solicitacoes de posicao</div>
              <div class="mt-2 space-y-2">
                {% for claim in claims %}
                  <div class="flex items-center justify-between gap-3">
                    <span class="text-sm text-ink">{{ claim.requestor_acolyte.display_name }}</span>
                    <button
                      hx-post="{% url 'position_claim_choose' claim.id %}"
                      hx-target="#assignment-{{ hero_assignment.id }}"
                      hx-swap="outerHTML"
                      hx-vals='{"return": "dashboard_hero"}'
                      class="btn-secondary btn-compact"
                      type="button">
                      Ceder
                    </button>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}

          {% if hero_assignment.confirmation_status == 'confirmed' %}
            <div class="text-sm font-medium text-ink ml-auto">
              Confirmado
            </div>
            {% if hero_has_swap_options %}
              <a href="{% url 'swap_request_create' hero_assignment.id %}" class="btn-secondary w-full md:w-auto text-center">Solicitar troca</a>
            {% endif %}
          {% else %}
            <button
              hx-post="{% url 'confirm_assignment' hero_assignment.id %}"
              hx-target="#assignment-{{ hero_assignment.id }}"
              hx-swap="outerHTML"
              hx-vals='{"return": "dashboard_hero"}'
              class="btn-primary w-full md:w-auto"
              type="button">
              Confirmar presenca
            </button>
            <button
              hx-post="{% url 'decline_assignment' hero_assignment.id %}"
              hx-target="#assignment-{{ hero_assignment.id }}"
              hx-swap="outerHTML"
              hx-vals='{"return": "dashboard_hero"}'
              hx-confirm="Tem certeza que deseja recusar esta escala?"
              class="btn-link w-full md:w-auto"
              type="button">
              Recusar
            </button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endwith %}
{% endif %}
