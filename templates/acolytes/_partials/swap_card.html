{% load extras %}
<div class="bg-white border border-sand-200 rounded-lg p-4 hover:border-sand-300 transition-colors" id="swap-{{ swap.id }}">
  <div class="flex items-start justify-between gap-4 mb-3">
    {# Main info #}
    <div class="flex-1 min-w-0">
      {# Date, time, location #}
      <div class="text-sm text-ink-600 mb-2">
        {{ swap.mass_instance.starts_at|date:"H:i" }} · {{ swap.mass_instance.community.short_name|default:swap.mass_instance.community.name }} · {{ swap.mass_instance.starts_at|date:"d/m/Y" }}
      </div>

      {# Swap details #}
      <div class="text-base font-medium text-ink mb-1">
        {% if swap.swap_type == "role_swap" %}
          {% if swap.target_acolyte %}
            Trocar {{ swap.from_slot.position_type.name }} → {{ swap.to_slot.position_type.name }}
            <div class="text-sm font-normal text-ink-600 mt-1">
              {% if swap.status == "awaiting_approval" %}
                Aprovado por <span class="font-medium">{{ swap.target_acolyte.user.first_name|default:swap.target_acolyte.display_name }}</span> · Aguardando coordenação
              {% elif swap.requestor_acolyte.user_id == request.user.id %}
                Solicitado para <span class="font-medium">{{ swap.target_acolyte.user.first_name|default:swap.target_acolyte.display_name }}</span>
              {% elif swap.target_acolyte.user_id == request.user.id %}
                Solicitado por <span class="font-medium">{{ swap.requestor_acolyte.user.first_name|default:swap.requestor_acolyte.display_name }}</span>
              {% else %}
                Entre <span class="font-medium">{{ swap.requestor_acolyte.user.first_name|default:swap.requestor_acolyte.display_name }}</span> e <span class="font-medium">{{ swap.target_acolyte.user.first_name|default:swap.target_acolyte.display_name }}</span>
              {% endif %}
            </div>
          {% else %}
            Trocar {{ swap.from_slot.position_type.name }} → {{ swap.to_slot.position_type.name }}
            <div class="text-sm font-normal text-ink-600 mt-1">
              {% if swap.open_to_admin %}
                Aguardando coordenação
              {% else %}
                Solicitado por <span class="font-medium">{{ swap.requestor_acolyte.user.first_name|default:swap.requestor_acolyte.display_name }}</span>
              {% endif %}
            </div>
          {% endif %}
        {% else %}
          Troca de acólito
          <div class="text-sm font-normal text-ink-600 mt-1">
            {% if swap.status == "awaiting_approval" %}
              Aprovado por <span class="font-medium">{{ swap.target_acolyte.user.first_name|default:swap.target_acolyte.display_name }}</span> · Aguardando coordenação
            {% elif swap.target_acolyte %}
              Entre <span class="font-medium">{{ swap.requestor_acolyte.user.first_name|default:swap.requestor_acolyte.display_name }}</span> e <span class="font-medium">{{ swap.target_acolyte.user.first_name|default:swap.target_acolyte.display_name }}</span>
            {% elif swap.open_to_admin %}
              Aguardando atribuição
            {% endif %}
          </div>
        {% endif %}
      </div>

      {# Notes if present #}
      {% if swap.notes %}
        <div class="mt-2 px-3 py-2 bg-sand-50 rounded text-sm text-ink-600 border-l-2 border-sand-300">
          {{ swap.notes }}
        </div>
      {% endif %}
    </div>

    {# Status badge #}
    <div class="flex-shrink-0">
      {% if swap.open_to_admin and swap.status == "pending" %}
        <span class="inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium text-amber-700 bg-amber-50 border border-amber-200 rounded-full">
          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
          </svg>
          Aguardando coordenação
        </span>
      {% elif swap.status == "pending" %}
        <span class="text-xs text-amber-600">Pendente</span>
      {% elif swap.status == "awaiting_approval" %}
        <span class="inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium text-blue-700 bg-blue-50 border border-blue-200 rounded-full">
          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
          </svg>
          Aguardando aprovação
        </span>
      {% elif swap.status == "accepted" %}
        <span class="inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium text-moss-700 bg-moss-50 border border-moss-200 rounded-full">
          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
          </svg>
          Aceita
        </span>
      {% elif swap.status == "rejected" %}
        <span class="inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium text-ink-500 bg-sand-100 border border-sand-200 rounded-full">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          Recusada
        </span>
      {% elif swap.status == "canceled" %}
        <span class="inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium text-ink-500 bg-sand-100 border border-sand-200 rounded-full">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          Cancelada
        </span>
      {% endif %}
    </div>
  </div>

  {# Actions #}
  {% if swap.status == "pending" or swap.status == "awaiting_approval" %}
    <div class="flex flex-wrap items-center gap-2 pt-3 border-t border-sand-100">
      {# Target can accept/reject if pending #}
      {% if swap.target_acolyte and swap.target_acolyte.user_id == request.user.id and swap.status == "pending" %}
        <button
          hx-post="{% url 'swap_request_accept' swap.id %}"
          hx-target="#swap-{{ swap.id }}"
          hx-swap="outerHTML"
          class="btn-primary inline-flex items-center gap-2"
          type="button">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          Aceitar
        </button>
        <button
          hx-post="{% url 'swap_request_reject' swap.id %}"
          hx-target="#swap-{{ swap.id }}"
          hx-swap="outerHTML"
          hx-confirm="Tem certeza que deseja recusar esta troca?"
          class="btn-secondary inline-flex items-center gap-2"
          type="button">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          Recusar
        </button>
      {% endif %}

      {# Admin can approve if awaiting_approval #}
      {% if can_manage_parish and swap.status == "awaiting_approval" %}
        <button
          hx-post="{% url 'swap_request_approve' swap.id %}"
          hx-target="#swap-{{ swap.id }}"
          hx-swap="outerHTML"
          class="btn-primary inline-flex items-center gap-2"
          type="button">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          Aprovar
        </button>
      {% endif %}

      {# Admin can assign if open_to_admin #}
      {% if swap.open_to_admin and can_manage_parish and swap.status == "pending" %}
        <a
          href="{% url 'swap_request_assign' swap.id %}"
          class="btn-secondary inline-flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Atribuir acólito
        </a>
      {% endif %}

      {# Requestor can cancel if pending (but not if they are also the target seeing accept/reject) #}
      {% if swap.requestor_acolyte.user_id == request.user.id and swap.status == "pending" %}
        {% if not swap.target_acolyte or swap.target_acolyte.user_id != request.user.id %}
          <button
            hx-post="{% url 'swap_request_cancel' swap.id %}"
            hx-target="#swap-{{ swap.id }}"
            hx-swap="outerHTML"
            hx-confirm="Tem certeza que deseja cancelar esta solicitacao?"
            class="btn-danger inline-flex items-center gap-2"
            type="button">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Cancelar
          </button>
        {% endif %}
      {% endif %}

      {# Admin can cancel any pending swap (if not the requestor and not showing other buttons) #}
      {% if can_manage_parish and swap.status == "pending" and swap.requestor_acolyte.user_id != request.user.id %}
        {% if not swap.target_acolyte or swap.target_acolyte.user_id != request.user.id %}
          <button
            hx-post="{% url 'swap_request_cancel' swap.id %}"
            hx-target="#swap-{{ swap.id }}"
            hx-swap="outerHTML"
            hx-confirm="Tem certeza que deseja cancelar esta solicitacao?"
            class="btn-danger inline-flex items-center gap-2"
            type="button">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Cancelar
          </button>
        {% endif %}
      {% endif %}
    </div>
  {% endif %}
</div>
