{% extends 'base.html' %}
{% load extras %}
{% block title %}Preferencias{% endblock %}
{% block content %}
<div class="space-y-6">
  <div class="card">
    <h2 class="font-serif text-xl mb-1">Preferencias</h2>
    {% if not acolyte %}
      <p class="text-sm text-slate">Seu usuario nao esta vinculado a um perfil de acolito.</p>
    {% else %}
      <p class="text-sm text-slate">Atualize disponibilidade e preferencias para melhorar suas escalas.</p>
    {% endif %}
  </div>

  {% if acolyte %}
    <div class="grid lg:grid-cols-2 gap-6">
      <div class="space-y-6">
        <div class="card">
          <div>
            <h3 class="font-semibold">Minha rotina semanal</h3>
            <p class="text-sm text-slate">Indisponivel bloqueia. Disponivel apenas restringe e ativa o modo so nesses horarios.</p>
            <p class="text-xs text-slate mt-1">Horario final nao inclui o horario exato.</p>
          </div>

          <div class="mt-4 space-y-3">
            {% if any_day_rules %}
              <div class="border border-black/5 rounded-lg p-3">
                <div class="text-xs uppercase tracking-wide text-slate mb-1">Regra geral (qualquer dia)</div>
                <p class="text-xs text-slate mb-3">Aplica em todos os dias e pode restringir toda a agenda.</p>
                <div class="space-y-2">
                  {% for rule in any_day_rules %}
                    <div class="flex items-center justify-between gap-3">
                      <div>
                        <div class="text-sm text-slate">
                          {% if rule.rule_type == "unavailable" %}Indisponivel{% else %}Disponivel apenas{% endif %}
                        </div>
                        <div class="font-medium">
                          {% if rule.start_time or rule.end_time %}
                            {{ rule.start_time|time:"H:i"|default:"--:--" }}-{{ rule.end_time|time:"H:i"|default:"--:--" }}
                          {% else %}
                            Qualquer horario
                          {% endif %}
                        </div>
                        {% if rule.community %}
                          <div class="text-xs text-slate">Somente em {{ rule.community.code }}</div>
                        {% endif %}
                      </div>
                      <form method="post" action="{% url 'delete_availability' rule.id %}">
                        {% csrf_token %}
                        <button class="btn-secondary" type="submit">Remover</button>
                      </form>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}

            <div class="grid sm:grid-cols-2 gap-3">
              {% for day, label in weekday_choices %}
                <div class="border border-black/5 rounded-lg p-3">
                  <div class="text-xs uppercase tracking-wide text-slate mb-2">{{ label }}</div>
                  {% with rules=weekly_by_day|get_list_item:day %}
                    {% if rules %}
                      <div class="space-y-2">
                        {% for rule in rules %}
                          <div class="flex items-center justify-between gap-3">
                            <div>
                              <div class="text-sm text-slate">
                                {% if rule.rule_type == "unavailable" %}Indisponivel{% else %}Disponivel apenas{% endif %}
                              </div>
                              <div class="font-medium">
                                {% if rule.start_time or rule.end_time %}
                                  {{ rule.start_time|time:"H:i"|default:"--:--" }}-{{ rule.end_time|time:"H:i"|default:"--:--" }}
                                {% else %}
                                  Qualquer horario
                                {% endif %}
                              </div>
                              {% if rule.community %}
                                <div class="text-xs text-slate">Somente em {{ rule.community.code }}</div>
                              {% endif %}
                            </div>
                            <form method="post" action="{% url 'delete_availability' rule.id %}">
                              {% csrf_token %}
                              <button class="btn-secondary" type="submit">Remover</button>
                            </form>
                          </div>
                        {% endfor %}
                      </div>
                    {% else %}
                      <span class="text-xs text-slate">Livre</span>
                    {% endif %}
                  {% endwith %}
                </div>
              {% endfor %}
            </div>
          </div>

          <details class="mt-4">
            <summary class="cursor-pointer inline-flex items-center gap-2 text-sm px-4 py-2 rounded-full border border-black/10 bg-white">
              Adicionar rotina
            </summary>
            <form method="post" class="space-y-3 mt-3">
              {% csrf_token %}
              <input type="hidden" name="form_type" value="weekly_availability" />
              {{ weekly_form.non_field_errors }}
              <div class="grid sm:grid-cols-2 gap-3">
                 <div>
                   <label class="label">Dia da semana</label>
                   <div class="custom-select">
                     <input type="hidden" name="day_of_week" value="{{ weekly_form.day_of_week.value }}">
                     <button type="button" class="custom-select-button">
                       <span class="selected-text">
                         {% if weekly_form.day_of_week.value %}
                           {% for choice_value, choice_label in weekly_form.day_of_week.field.choices %}
                             {% if weekly_form.day_of_week.value == choice_value %}{{ choice_label }}{% endif %}
                           {% endfor %}
                         {% else %}
                           Selecionar...
                         {% endif %}
                       </span>
                     </button>
                     <div class="custom-select-options">
                       {% for choice_value, choice_label in weekly_form.day_of_week.field.choices %}
                         <button type="button" class="custom-select-option {% if weekly_form.day_of_week.value == choice_value %}selected{% endif %}" data-value="{{ choice_value }}">{{ choice_label }}</button>
                       {% endfor %}
                     </div>
                   </div>
                   {% if weekly_form.day_of_week.errors %}<div class="form-error">{{ weekly_form.day_of_week.errors.0 }}</div>{% endif %}
                 </div>
                 <div>
                   <label class="label">Tipo</label>
                   <div class="custom-select">
                     <input type="hidden" name="rule_type" value="{{ weekly_form.rule_type.value }}">
                     <button type="button" class="custom-select-button">
                       <span class="selected-text">
                         {% if weekly_form.rule_type.value %}
                           {% for choice_value, choice_label in weekly_form.rule_type.field.choices %}
                             {% if weekly_form.rule_type.value == choice_value %}{{ choice_label }}{% endif %}
                           {% endfor %}
                         {% else %}
                           Selecionar...
                         {% endif %}
                       </span>
                     </button>
                     <div class="custom-select-options">
                       {% for choice_value, choice_label in weekly_form.rule_type.field.choices %}
                         <button type="button" class="custom-select-option {% if weekly_form.rule_type.value == choice_value %}selected{% endif %}" data-value="{{ choice_value }}">{{ choice_label }}</button>
                       {% endfor %}
                     </div>
                   </div>
                   {% if weekly_form.rule_type.errors %}<div class="form-error">{{ weekly_form.rule_type.errors.0 }}</div>{% endif %}
                 </div>
                <div>
                  <label class="label">Inicio</label>
                  {{ weekly_form.start_time }}
                  {{ weekly_form.start_time.errors }}
                </div>
                <div>
                  <label class="label">Fim</label>
                  {{ weekly_form.end_time }}
                  {{ weekly_form.end_time.errors }}
                </div>
                 <div class="sm:col-span-2">
                   <label class="label">Comunidade (opcional)</label>
                   <div class="custom-select">
                     <input type="hidden" name="community" value="{{ weekly_form.community.value }}">
                     <button type="button" class="custom-select-button">
                       <span class="selected-text">
                         {% if weekly_form.community.value %}
                           {% for choice_value, choice_label in weekly_form.community.field.choices %}
                             {% if weekly_form.community.value == choice_value %}{{ choice_label|slice:":3" }}{% endif %}
                           {% endfor %}
                         {% else %}
                           Selecionar...
                         {% endif %}
                       </span>
                     </button>
                     <div class="custom-select-options">
                       {% for choice_value, choice_label in weekly_form.community.field.choices %}
                         <button type="button" class="custom-select-option {% if weekly_form.community.value == choice_value %}selected{% endif %}" data-value="{{ choice_value }}">{{ choice_label|slice:":3" }}</button>
                       {% endfor %}
                     </div>
                   </div>
                   {% if weekly_form.community.errors %}<div class="form-error">{{ weekly_form.community.errors.0 }}</div>{% endif %}
                 </div>
                <div class="sm:col-span-2">
                  <label class="label">Notas</label>
                  {{ weekly_form.notes }}
                  {{ weekly_form.notes.errors }}
                </div>
              </div>
              <button class="btn-secondary">Salvar rotina</button>
            </form>
          </details>
        </div>

        <div class="card">
          <div>
            <h3 class="font-semibold">Ausencias por data</h3>
            <p class="text-sm text-slate">Sempre bloqueiam e tem prioridade sobre a rotina semanal.</p>
          </div>
          <div class="mt-4 space-y-2">
            {% for rule in date_absences %}
              <div class="border border-black/5 rounded-lg p-3 flex items-center justify-between gap-3">
                <div>
                  <div class="font-medium">
                    {{ rule.start_date|date:"d/m/Y" }}
                    {% if rule.end_date and rule.end_date != rule.start_date %}
                      - {{ rule.end_date|date:"d/m/Y" }}
                    {% endif %}
                  </div>
                  {% if rule.notes %}
                    <div class="text-sm text-slate">{{ rule.notes }}</div>
                  {% endif %}
                </div>
                <form method="post" action="{% url 'delete_availability' rule.id %}">
                  {% csrf_token %}
                  <button class="btn-secondary" type="submit">Remover</button>
                </form>
              </div>
            {% empty %}
              <p class="text-sm text-slate">Nenhuma ausencia cadastrada.</p>
            {% endfor %}
          </div>
          <details class="mt-4">
            <summary class="cursor-pointer inline-flex items-center gap-2 text-sm px-4 py-2 rounded-full border border-black/10 bg-white">
              Adicionar ausencia
            </summary>
            <form method="post" class="space-y-3 mt-3">
              {% csrf_token %}
              <input type="hidden" name="form_type" value="date_absence" />
              {{ date_absence_form.non_field_errors }}
              <div class="grid sm:grid-cols-2 gap-3">
                <div>
                  <label class="label">Data inicio</label>
                  {{ date_absence_form.start_date }}
                  {{ date_absence_form.start_date.errors }}
                </div>
                <div>
                  <label class="label">Data fim (opcional)</label>
                  {{ date_absence_form.end_date }}
                  {{ date_absence_form.end_date.errors }}
                </div>
                <div class="sm:col-span-2">
                  <label class="label">Motivo</label>
                  {{ date_absence_form.notes }}
                  {{ date_absence_form.notes.errors }}
                </div>
              </div>
              <button class="btn-secondary">Salvar ausencia</button>
            </form>
          </details>
        </div>
      </div>

      <div class="space-y-6">
        {% if diagnostics %}
          <div class="card">
            <h3 class="font-semibold">Diagnostico rapido</h3>
            <p class="text-sm text-slate">Resumo das oportunidades nos proximos 30 dias.</p>
            <div class="mt-4 grid sm:grid-cols-2 gap-3 text-sm">
              <div class="border border-black/5 rounded-lg p-3">
                <div class="text-xs text-slate uppercase tracking-wide">Missas no periodo</div>
                <div class="text-xl font-semibold">{{ diagnostics.total }}</div>
              </div>
              <div class="border border-black/5 rounded-lg p-3">
                <div class="text-xs text-slate uppercase tracking-wide">Oportunidades elegiveis</div>
                <div class="text-xl font-semibold">{{ diagnostics.eligible_opportunities }}</div>
              </div>
              <div class="border border-black/5 rounded-lg p-3">
                <div class="text-xs text-slate uppercase tracking-wide">Qualificacoes</div>
                <div class="text-xl font-semibold">{{ diagnostics.qualified_positions }}</div>
              </div>
              <div class="border border-black/5 rounded-lg p-3">
                <div class="text-xs text-slate uppercase tracking-wide">Bloqueios por disponibilidade</div>
                <div class="text-xl font-semibold">{{ diagnostics.blocked_availability }}</div>
              </div>
            </div>
            {% if diagnostics.reasons %}
              <div class="mt-4 text-sm text-slate">
                <p class="font-medium text-ink">Possiveis motivos:</p>
                <ul class="list-disc list-inside space-y-1">
                  {% for reason in diagnostics.reasons %}
                    <li>{{ reason }}</li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
          </div>
        {% endif %}

        <div class="card">
          <div>
            <h3 class="font-semibold">Preferencias atuais</h3>
            <p class="text-sm text-slate">Resumo simples para facilitar a leitura.</p>
          </div>
          <div class="mt-4 space-y-2">
            {% for pref in preferences %}
              <div class="border border-black/5 rounded-lg p-3 flex items-center justify-between gap-3">
                <div>
                  <div class="font-medium">{{ pref|preference_summary }}</div>
                  <div class="flex items-center gap-2 text-xs uppercase tracking-wide text-slate mt-1">
                    <span class="px-2 py-0.5 rounded-full bg-sand text-ink/70">{{ pref.weight|preference_priority_label }}</span>
                    {% with detail=pref|preference_detail %}
                      {% if detail %}
                        <span>{{ detail }}</span>
                      {% endif %}
                    {% endwith %}
                  </div>
                </div>
                <form method="post" action="{% url 'delete_preference' pref.id %}">
                  {% csrf_token %}
                  <button class="btn-secondary" type="submit">Remover</button>
                </form>
              </div>
            {% empty %}
              <p class="text-sm text-slate">Nenhuma preferencia cadastrada.</p>
            {% endfor %}
          </div>
        </div>

        <div class="card">
          <div>
            <h3 class="font-semibold">Adicionar preferencia</h3>
            <p class="text-sm text-slate">Prioridade alta reforca, mas nao garante.</p>
          </div>
          <form method="post" class="space-y-3 mt-4">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="preference" />
            {{ preference_form.non_field_errors }}
            {{ preference_form.weight.as_hidden }}
            <div class="grid sm:grid-cols-2 gap-3">
               <div class="sm:col-span-2">
                 <label class="label">Tipo</label>
                 <div class="custom-select">
                   <input type="hidden" name="preference_type" value="{{ preference_form.preference_type.value }}">
                   <button type="button" class="custom-select-button">
                     <span class="selected-text">
                       {% if preference_form.preference_type.value %}
                         {% for choice_value, choice_label in preference_form.preference_type.field.choices %}
                           {% if preference_form.preference_type.value == choice_value %}{{ choice_label }}{% endif %}
                         {% endfor %}
                       {% else %}
                         Selecionar...
                       {% endif %}
                     </span>
                   </button>
                   <div class="custom-select-options">
                     {% for choice_value, choice_label in preference_form.preference_type.field.choices %}
                       <button type="button" class="custom-select-option {% if preference_form.preference_type.value == choice_value %}selected{% endif %}" data-value="{{ choice_value }}">{{ choice_label }}</button>
                     {% endfor %}
                   </div>
                 </div>
                 {% if preference_form.preference_type.errors %}<div class="form-error">{{ preference_form.preference_type.errors.0 }}</div>{% endif %}
               </div>
              <div class="sm:col-span-2">
                <label class="label">Prioridade</label>
                {% with weight_value=preference_form.weight.value|default:50 %}
                  <div class="flex flex-wrap gap-2" id="pref_priority_group">
                    <button type="button" data-priority="25"
                      class="px-4 py-2 rounded-full border text-sm {% if weight_value|stringformat:"s" == "25" %}bg-ink text-white border-ink{% else %}border-black/10 text-slate{% endif %}">
                      Baixa
                    </button>
                    <button type="button" data-priority="50"
                      class="px-4 py-2 rounded-full border text-sm {% if weight_value|stringformat:"s" == "50" %}bg-ink text-white border-ink{% else %}border-black/10 text-slate{% endif %}">
                      Media
                    </button>
                    <button type="button" data-priority="100"
                      class="px-4 py-2 rounded-full border text-sm {% if weight_value|stringformat:"s" == "100" %}bg-ink text-white border-ink{% else %}border-black/10 text-slate{% endif %}">
                      Alta
                    </button>
                  </div>
                {% endwith %}
              </div>
               <div class="sm:col-span-2 hidden" data-pref-field="target_community">
                 <label class="label">Comunidade</label>
                 <div class="custom-select">
                   <input type="hidden" name="target_community" value="{{ preference_form.target_community.value }}">
                   <button type="button" class="custom-select-button">
                     <span class="selected-text">
                       {% if preference_form.target_community.value %}
                         {% for choice_value, choice_label in preference_form.target_community.field.choices %}
                           {% if preference_form.target_community.value == choice_value %}{{ choice_label|slice:":3" }}{% endif %}
                         {% endfor %}
                       {% else %}
                         Selecionar...
                       {% endif %}
                     </span>
                   </button>
                   <div class="custom-select-options">
                     {% for choice_value, choice_label in preference_form.target_community.field.choices %}
                       <button type="button" class="custom-select-option {% if preference_form.target_community.value == choice_value %}selected{% endif %}" data-value="{{ choice_value }}">{{ choice_label|slice:":3" }}</button>
                     {% endfor %}
                   </div>
                 </div>
                 {% if preference_form.target_community.errors %}<div class="form-error">{{ preference_form.target_community.errors.0 }}</div>{% endif %}
              </div>
              <div class="sm:col-span-2 hidden" data-pref-field="target_position">
                <label class="label">Posicao</label>
                {{ preference_form.target_position }}
                {{ preference_form.target_position.errors }}
              </div>
              <div class="sm:col-span-2 hidden" data-pref-field="target_function">
                <label class="label">Funcao</label>
                {{ preference_form.target_function }}
                {{ preference_form.target_function.errors }}
              </div>
              <div class="sm:col-span-2 hidden" data-pref-field="target_template">
                <label class="label">Modelo</label>
                {{ preference_form.target_template }}
                {{ preference_form.target_template.errors }}
              </div>
              <div class="sm:col-span-2 hidden" data-pref-field="target_acolyte">
                <label class="label">Parceiro</label>
                {{ preference_form.target_acolyte }}
                {{ preference_form.target_acolyte.errors }}
              </div>
              <div class="hidden" data-pref-field="weekday">
                <label class="label">Dia da semana</label>
                {{ preference_form.weekday }}
                {{ preference_form.weekday.errors }}
              </div>
              <div class="hidden" data-pref-field="start_time">
                <label class="label">Horario inicio</label>
                {{ preference_form.start_time }}
                {{ preference_form.start_time.errors }}
              </div>
              <div class="hidden" data-pref-field="end_time">
                <label class="label">Horario fim</label>
                {{ preference_form.end_time }}
                {{ preference_form.end_time.errors }}
              </div>
            </div>
            <button class="btn-secondary">Salvar preferencia</button>
          </form>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<script>
  (function () {
    const typeSelect = document.getElementById("id_preference_type");
    const weightInput = document.getElementById("id_weight");
    const priorityButtons = document.querySelectorAll("[data-priority]");
    const groups = document.querySelectorAll("[data-pref-field]");
    const mapping = {
      preferred_community: ["target_community"],
      avoid_community: ["target_community"],
      preferred_position: ["target_position"],
      avoid_position: ["target_position"],
      preferred_function: ["target_function"],
      avoid_function: ["target_function"],
      preferred_mass_template: ["target_template"],
      preferred_partner: ["target_acolyte"],
      avoid_partner: ["target_acolyte"],
      preferred_timeslot: ["weekday", "start_time", "end_time"],
    };

    function resetField(el) {
      if (el.tagName === "SELECT") {
        el.selectedIndex = 0;
        return;
      }
      if (el.type === "checkbox" || el.type === "radio") {
        el.checked = false;
        return;
      }
      el.value = "";
    }

    function updateFields() {
      if (!typeSelect) {
        return;
      }
      const allowed = mapping[typeSelect.value] || [];
      groups.forEach((group) => {
        const field = group.getAttribute("data-pref-field");
        const show = allowed.includes(field);
        group.classList.toggle("hidden", !show);
        group.querySelectorAll("select, input, textarea").forEach((el) => {
          el.disabled = !show;
          if (!show) {
            resetField(el);
          }
        });
      });
    }

    function setPriority(value) {
      if (!weightInput) {
        return;
      }
      weightInput.value = value;
      priorityButtons.forEach((btn) => {
        const isActive = btn.dataset.priority === value;
        btn.classList.toggle("bg-ink", isActive);
        btn.classList.toggle("text-white", isActive);
        btn.classList.toggle("border-ink", isActive);
        btn.classList.toggle("border-black/10", !isActive);
        btn.classList.toggle("text-slate", !isActive);
      });
    }

    if (typeSelect) {
      typeSelect.addEventListener("change", updateFields);
      updateFields();
    }
    priorityButtons.forEach((btn) => {
      btn.addEventListener("click", () => setPriority(btn.dataset.priority));
    });
    if (weightInput) {
      setPriority(weightInput.value || "50");
    }
  })();
</script>
{% endblock %}
