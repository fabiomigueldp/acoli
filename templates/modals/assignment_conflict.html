{% if show_conflict_modal %}
<!-- Modal Backdrop -->
<div id="assignmentConflictModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center" onclick="if(event.target === this) closeConflictModal()">
  <!-- Modal Content -->
  <div class="bg-white rounded-t-2xl sm:rounded-2xl shadow-soft border border-black/10 max-w-md w-full mx-4 overflow-hidden max-h-[85vh]" onclick="event.stopPropagation()">
    <!-- Modal Header -->
    <div class="px-6 py-4 border-b border-black/10 flex items-center justify-between">
      <h3 class="text-xl font-serif text-ink">Conflito de Atribuição</h3>
      <button type="button" class="p-2 -mr-2 text-slate hover:text-ink" onclick="closeConflictModal()" aria-label="Fechar">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    
    <!-- Modal Body -->
    <div class="px-6 py-6 space-y-3 text-sm">
      <p>O acólito <strong class="text-moss">{{ conflict_acolyte.display_name }}</strong> já está atribuído à posição <strong class="text-moss">{{ current_slot.position_type.name }}</strong> nesta missa.</p>
      <p class="text-slate">Deseja movê-lo para a posição <strong class="text-ink">{{ new_slot.position_type.name }}</strong>?</p>
    </div>
    
    <!-- Modal Footer -->
    <div class="px-6 py-4 bg-sand/30 border-t border-black/10 flex flex-col-reverse sm:flex-row items-center justify-end gap-3">
      <button type="button" class="btn-secondary w-full sm:w-auto" onclick="closeConflictModal()">Cancelar</button>
      <form method="post" action="{% url 'move_acolyte' instance.id new_slot.id %}" style="display: inline;" onsubmit="handleMoveSubmit(event)">
        {% csrf_token %}
        <input type="hidden" name="current_slot_id" value="{{ current_slot.id }}">
        <input type="hidden" name="acolyte_id" value="{{ conflict_acolyte.id }}">
        <button type="submit" class="btn-primary w-full sm:w-auto" id="moveButton">Mover para Esta Posição</button>
      </form>
    </div>
  </div>
</div>

<script>
  // Show modal immediately
  document.getElementById('assignmentConflictModal').style.display = 'flex';
  
  // Close modal function
  function closeConflictModal() {
    // Remove query params and redirect to clean URL
    window.location.href = "{% url 'mass_detail' instance.id %}";
  }
  
  // Handle form submission
  function handleMoveSubmit(event) {
    // Disable button to prevent double-submit
    const button = document.getElementById('moveButton');
    button.disabled = true;
    button.textContent = 'Movendo...';
    // Form will submit normally
  }
  
  // Close on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeConflictModal();
    }
  });
</script>
{% endif %}
